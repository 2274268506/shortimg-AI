# 用户管理功能完善说明

## 概述

本次更新完善了图床系统的用户管理功能，为管理员提供了更强大的用户管理工具，包括批量操作、用户创建、信息编辑、数据导出等功能。

## 新增功能

### 1. 批量操作功能 ✅

管理员可以选择多个用户进行批量操作：

- **批量启用**：一次性启用多个已禁用的用户账号
- **批量禁用**：一次性禁用多个用户账号（不能禁用自己）
- **批量删除**：一次性删除多个用户（不能删除自己）

**使用方法**：
1. 在用户列表中勾选要操作的用户
2. 点击表格上方的批量操作按钮
3. 确认操作即可

**安全机制**：
- 系统会自动过滤掉当前登录的管理员账号，防止误操作
- 所有批量操作都需要二次确认

### 2. 用户创建功能 ✅

管理员可以直接创建新用户账号，无需用户自行注册：

**创建字段**：
- 用户名：必填，3-50个字符
- 邮箱：必填，需符合邮箱格式
- 密码：必填，至少6位
- 确认密码：必填，需与密码一致
- 角色：选填，普通用户或管理员

**API 接口**：
```
POST /api/users
Content-Type: application/json

{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "password123",
  "role": "user"
}
```

**验证规则**：
- 用户名不能重复
- 邮箱不能重复
- 密码长度至少6位
- 新创建的用户默认状态为"启用"

### 3. 用户信息编辑功能 ✅

管理员可以编辑用户的基本信息：

**可编辑字段**：
- 用户名：可修改，但不能与其他用户重复
- 邮箱：可修改，但不能与其他用户重复
- 个人简介：可修改

**API 接口**：
```
PUT /api/users/:id
Content-Type: application/json

{
  "username": "updatedname",
  "email": "updated@example.com",
  "bio": "这是更新后的个人简介"
}
```

**注意事项**：
- 修改用户名或邮箱时，系统会检查是否与其他用户冲突
- 不能通过此接口修改密码，请使用"重置密码"功能

### 4. 用户详情展示优化 ✅

优化了用户详情对话框，增加了更多信息展示：

**基本信息**：
- 用户ID、用户名、邮箱
- 角色、状态
- 注册时间、最后登录时间
- 登录IP、个人简介

**统计信息**：
- 图片数量
- 相册数量
- 存储空间（格式化显示）
- 总浏览量
- 总下载量

**最近上传的图片**（新增）：
- 显示用户最近上传的6张图片
- 以卡片形式展示，包含缩略图
- 显示图片名称、大小、上传时间
- 支持点击预览大图

**API 接口**：
```
GET /api/users/:id/images?limit=6
```

### 5. 用户列表导出功能 ✅

支持将用户列表导出为 CSV 文件，方便数据分析和备份：

**导出内容**：
- 用户ID
- 用户名
- 邮箱
- 角色（中文显示：管理员/普通用户）
- 状态（中文显示：启用/禁用）
- 注册时间
- 最后登录时间
- 登录IP

**使用方法**：
1. 点击"导出用户"按钮
2. 系统自动生成 CSV 文件并下载
3. 文件名格式：`用户列表_YYYY-MM-DD.csv`

**技术特点**：
- 使用 UTF-8 BOM 编码，确保 Excel 正确识别中文
- 自动处理特殊字符，确保数据完整性
- 纯前端实现，无需后端支持

### 6. 用户活动日志（待实现）

**规划功能**：
- 记录用户的关键操作
- 包括登录、上传、删除等行为
- 显示操作时间、IP地址、操作详情
- 支持日志筛选和搜索

**数据表设计建议**：
```sql
CREATE TABLE user_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  action VARCHAR(50) NOT NULL,
  details TEXT,
  ip_address VARCHAR(50),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at)
);
```

## 前端实现

### 组件结构

**文件位置**：`frontend/src/views/Users.vue`

**主要组件**：
- 用户列表表格（支持多选）
- 批量操作工具栏
- 用户详情对话框
- 创建用户对话框
- 编辑用户对话框
- 重置密码对话框

### API 封装

**文件位置**：`frontend/src/api/index.ts`

新增的 API 方法：
```typescript
// 创建用户
export const createUser(data: {
  username: string
  email: string
  password: string
  role: string
})

// 更新用户信息
export const updateUser(id: number, data: {
  username: string
  email: string
  bio?: string
})

// 获取用户最近图片
export const getUserRecentImages(id: number, limit: number = 6)
```

## 后端实现

### 控制器

**文件位置**：`backend/controllers/user_controller.go`

新增的控制器方法：
```go
// CreateUser 创建用户（管理员）
func CreateUser(c *gin.Context)

// UpdateUser 更新用户信息（管理员）
func UpdateUser(c *gin.Context)

// GetUserRecentImages 获取用户最近上传的图片（管理员）
func GetUserRecentImages(c *gin.Context)
```

### 路由配置

**文件位置**：`backend/routes/routes.go`

新增的路由：
```go
users.POST("", controllers.CreateUser)              // 创建用户
users.PUT("/:id", controllers.UpdateUser)           // 更新用户信息
users.GET("/:id/images", controllers.GetUserRecentImages) // 获取用户最近图片
```

## 安全特性

### 权限控制

所有用户管理功能都需要管理员权限：
```go
users.Use(middleware.AuthMiddleware(), middleware.AdminMiddleware())
```

### 数据验证

#### 创建用户验证
- 用户名：3-50个字符
- 邮箱：符合邮箱格式
- 密码：至少6位
- 角色：只能是 `user` 或 `admin`

#### 更新用户验证
- 用户名：3-50个字符，不能与其他用户重复
- 邮箱：符合邮箱格式，不能与其他用户重复

#### 自我保护
- 管理员不能禁用自己的账号
- 管理员不能删除自己的账号

### 密码安全

- 所有密码使用 bcrypt 加密存储
- 密码不会出现在任何 API 响应中
- 重置密码需要单独的接口和权限

## 使用示例

### 1. 创建新用户

```bash
# 请求
curl -X POST http://localhost:8080/api/users \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123",
    "role": "user"
  }'

# 响应
{
  "data": {
    "id": 5,
    "username": "testuser",
    "email": "test@example.com",
    "role": "user",
    "status": "active",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 2. 更新用户信息

```bash
# 请求
curl -X PUT http://localhost:8080/api/users/5 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser_updated",
    "email": "test_updated@example.com",
    "bio": "这是我的个人简介"
  }'

# 响应
{
  "data": {
    "id": 5,
    "username": "testuser_updated",
    "email": "test_updated@example.com",
    "role": "user",
    "status": "active",
    "bio": "这是我的个人简介"
  }
}
```

### 3. 获取用户最近图片

```bash
# 请求
curl -X GET "http://localhost:8080/api/users/5/images?limit=6" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 响应
{
  "data": [
    {
      "id": 123,
      "uuid": "abc123",
      "fileName": "image1.jpg",
      "originalName": "我的图片.jpg",
      "url": "http://example.com/uploads/image1.jpg",
      "thumbnail": "http://example.com/uploads/thumb_image1.jpg",
      "fileSize": 1024000,
      "createdAt": "2024-01-15T10:00:00Z"
    }
  ]
}
```

### 4. 批量操作

前端会自动调用相应的 API：
- 批量启用：循环调用 `PUT /api/users/:id/status` 设置 status 为 "active"
- 批量禁用：循环调用 `PUT /api/users/:id/status` 设置 status 为 "disabled"
- 批量删除：循环调用 `DELETE /api/users/:id`

## 测试建议

### 功能测试

1. **创建用户测试**
   - 测试正常创建
   - 测试用户名重复
   - 测试邮箱重复
   - 测试密码长度不足

2. **编辑用户测试**
   - 测试正常编辑
   - 测试用户名冲突
   - 测试邮箱冲突

3. **批量操作测试**
   - 测试批量启用
   - 测试批量禁用（包含自己）
   - 测试批量删除（包含自己）

4. **用户详情测试**
   - 测试统计数据正确性
   - 测试最近图片显示
   - 测试无图片用户

5. **导出功能测试**
   - 测试导出文件格式
   - 测试中文显示
   - 测试特殊字符处理

### 性能测试

- 测试大量用户列表的加载性能
- 测试批量操作的响应时间
- 测试用户详情对话框的加载速度

## 未来优化方向

1. **用户活动日志**
   - 实现操作日志记录
   - 添加日志查看界面
   - 支持日志筛选和导出

2. **高级搜索**
   - 支持多条件组合搜索
   - 支持日期范围筛选
   - 支持存储空间范围筛选

3. **用户分组**
   - 支持用户标签
   - 支持用户分组管理
   - 支持按组批量操作

4. **权限细化**
   - 更细粒度的权限控制
   - 自定义角色功能
   - 权限组管理

5. **批量导入**
   - 支持 CSV/Excel 批量导入用户
   - 支持批量创建账号
   - 支持导入验证和错误提示

## 变更日志

### v1.2.0 (2024-12-24)

**新增功能**：
- ✅ 批量启用/禁用/删除用户
- ✅ 管理员创建用户功能
- ✅ 用户信息编辑功能
- ✅ 用户详情展示优化（添加最近上传图片）
- ✅ 用户列表 CSV 导出功能

**API 变更**：
- 新增 `POST /api/users` - 创建用户
- 新增 `PUT /api/users/:id` - 更新用户信息
- 新增 `GET /api/users/:id/images` - 获取用户最近图片

**前端变更**：
- 优化用户管理页面布局
- 添加批量操作工具栏
- 优化用户详情对话框
- 添加创建和编辑用户对话框

**后端变更**：
- 新增创建用户控制器
- 新增更新用户控制器
- 新增获取用户图片控制器
- 完善数据验证逻辑

## 总结

本次更新大幅提升了用户管理功能的完整性和易用性，为管理员提供了强大的用户管理工具。通过批量操作、快速创建、信息编辑、数据导出等功能，管理员可以更高效地管理系统用户。

所有功能都经过了安全性考虑，包括权限控制、数据验证、自我保护等机制，确保系统的安全稳定运行。

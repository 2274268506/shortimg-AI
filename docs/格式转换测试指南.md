# 格式转换功能测试指南

## 测试前准备

1. 确保后端服务运行正常
2. 确保前端开发服务器运行
3. 准备几张不同格式的测试图片

## 测试步骤

### 1. 测试获取格式列表 API

```bash
# 使用 curl 测试
curl http://localhost:8080/api/images/formats

# 预期响应
{
  "code": 200,
  "message": "success",
  "data": {
    "supported": ["jpg", "jpeg", "png", "gif", "webp", "bmp", "tiff", "tif"],
    "animated": ["gif"]
  }
}
```

### 2. 测试单张图片格式转换

#### 2.1 先上传一张测试图片

通过前端界面上传一张 PNG 格式的图片,记下图片 ID(假设为 123)

#### 2.2 使用 API 转换格式

```bash
# 将 PNG 转为 JPG
curl -X PUT http://localhost:8080/api/images/123/convert \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "format": "jpg",
    "quality": 90
  }'
```

#### 2.3 验证结果

- 检查响应中的 fileName 是否已更改为 .jpg
- 在前端刷新图片列表,确认文件名和格式已更新
- 下载转换后的图片,确认格式正确

### 3. 测试批量格式转换

#### 3.1 准备多张图片

上传 5 张不同格式的图片(如 2张PNG, 2张JPG, 1张GIF),记下它们的 ID

#### 3.2 批量转换

```bash
# 批量转为 WebP
curl -X POST http://localhost:8080/api/images/batch-convert \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "ids": [1, 2, 3, 4, 5],
    "format": "webp",
    "quality": 85
  }'
```

#### 3.3 验证结果

- 检查 converted 数组,确认成功转换的图片
- 检查 errors 数组,查看是否有失败的图片
- 在前端刷新,确认所有图片格式已更新

### 4. 测试前端 UI

#### 4.1 单张转换

1. 在图片管理页面,找到任意图片
2. 点击图片的"转换"按钮(RefreshRight 图标)
3. 在弹出的对话框中:
   - 查看当前格式是否正确显示
   - 选择目标格式(不同于当前格式)
   - 调整质量滑块(试试不同值)
   - 点击"开始转换"
4. 等待转换完成,查看成功提示
5. 确认图片列表已更新

#### 4.2 动图转换警告

1. 上传一张 GIF 动图
2. 点击转换按钮
3. 选择静态格式(如 PNG)
4. 确认是否显示警告信息:"当前图片为动图,转换为静态格式后将丢失动画效果"
5. 继续转换,验证转换后确实是静态图片

#### 4.3 质量对比测试

1. 准备一张较大的 PNG 图片(如 2MB)
2. 分别转换为:
   - JPG 质量 50%
   - JPG 质量 75%
   - JPG 质量 90%
   - WebP 质量 85%
3. 对比文件大小和视觉质量

### 5. 边界测试

#### 5.1 相同格式转换

1. 对一张 JPG 图片,选择目标格式也为 JPG
2. 确认"开始转换"按钮是否被禁用(单张转换时)

#### 5.2 质量边界值

测试质量值:
- 最小值: 1
- 最大值: 100
- 推荐值: 90

#### 5.3 批量转换大量图片

1. 上传 20-50 张图片
2. 批量转换它们
3. 观察转换进度和结果
4. 确认部分失败不影响其他图片

### 6. 错误场景测试

#### 6.1 不存在的图片 ID

```bash
curl -X PUT http://localhost:8080/api/images/99999/convert \
  -H "Content-Type: application/json" \
  -d '{"format": "png"}'

# 预期: 404 Not Found
```

#### 6.2 无效的格式

```bash
curl -X PUT http://localhost:8080/api/images/123/convert \
  -H "Content-Type: application/json" \
  -d '{"format": "invalid"}'

# 预期: 400 Bad Request
```

#### 6.3 无效的质量值

```bash
curl -X PUT http://localhost:8080/api/images/123/convert \
  -H "Content-Type: application/json" \
  -d '{"format": "png", "quality": 150}'

# 预期: 400 Bad Request (质量超出范围)
```

## 性能测试

### 1. 单张大图片转换

- 上传一张 5MB 以上的大图
- 测量转换耗时
- 检查转换后文件大小变化

### 2. 批量转换性能

- 批量转换 50 张图片
- 测量总耗时
- 计算平均每张转换时间

### 3. 并发转换

- 同时发起多个转换请求
- 观察服务器负载
- 确认所有请求都能正常完成

## 预期结果

### 成功标准

✅ 所有支持的格式都能正常转换
✅ 转换后的图片格式正确
✅ 文件名扩展名正确更新
✅ 图片质量符合设定
✅ 批量转换能处理成功和失败的情况
✅ UI 交互流畅,错误提示清晰
✅ 动图转换警告正常显示

### 常见问题

**Q: 转换后图片变大了?**
A: 某些格式组合可能导致文件变大,如 JPG -> PNG。建议选择合适的目标格式。

**Q: GIF 转换后不动了?**
A: 正常现象。GIF 转为其他格式会丢失动画,系统已在转换前提示。

**Q: 批量转换部分失败?**
A: 检查失败图片的错误信息,可能是文件损坏或格式问题。成功的图片不受影响。

**Q: 转换很慢?**
A: 大图片或大批量转换需要时间。建议分批处理,单批不超过 50 张。

## 测试检查清单

- [ ] 格式列表 API 正常返回
- [ ] 单张图片转换成功
- [ ] 批量图片转换成功
- [ ] 转换后文件名正确
- [ ] 转换后格式正确
- [ ] 质量参数生效
- [ ] 动图警告显示
- [ ] 相同格式转换被阻止
- [ ] 错误提示友好
- [ ] 转换后列表自动刷新
- [ ] 所有 8 种格式都支持
- [ ] 边界值处理正确
- [ ] 并发请求正常
- [ ] 性能可接受

## 测试报告模板

```
测试日期: ___________
测试人员: ___________

功能测试:
- 格式列表 API: □ 通过 □ 失败
- 单张转换: □ 通过 □ 失败
- 批量转换: □ 通过 □ 失败
- UI 交互: □ 通过 □ 失败

性能测试:
- 单张大图(5MB): ___ 秒
- 批量 10 张: ___ 秒
- 批量 50 张: ___ 秒

问题记录:
1. ___________________________
2. ___________________________
3. ___________________________

总体评价: □ 优秀 □ 良好 □ 需改进
```

# 图片格式转换功能说明

## 功能概述

新增了图片格式转换功能,支持单张图片和批量图片的格式转换,提供8种常见图片格式支持。

## 支持的格式

### 静态图片格式
- **JPG/JPEG** - 有损压缩,适合照片,支持质量调节(1-100)
- **PNG** - 无损压缩,支持透明背景
- **WebP** - 现代格式,体积小质量高,支持质量调节(1-100)
- **BMP** - 位图格式,无压缩
- **TIFF/TIF** - 专业级格式,支持多页

### 动图格式
- **GIF** - 支持动画效果

## 后端 API

### 1. 获取支持的格式列表

```http
GET /api/images/formats
```

**响应:**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "supported": ["jpg", "jpeg", "png", "gif", "webp", "bmp", "tiff", "tif"],
    "animated": ["gif"]
  }
}
```

### 2. 单张图片格式转换

```http
PUT /api/images/:id/convert
```

**请求体:**
```json
{
  "format": "png",
  "quality": 90
}
```

**参数说明:**
- `format` (string, 必填): 目标格式,如 "png", "jpg", "webp" 等
- `quality` (int, 可选): 图片质量 1-100,默认 90

**响应:**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 123,
    "fileName": "image.png",
    "url": "http://example.com/images/123/file",
    ...
  }
}
```

### 3. 批量图片格式转换

```http
POST /api/images/batch-convert
```

**请求体:**
```json
{
  "ids": [1, 2, 3, 4, 5],
  "format": "webp",
  "quality": 85
}
```

**参数说明:**
- `ids` ([]int, 必填): 要转换的图片ID列表
- `format` (string, 必填): 目标格式
- `quality` (int, 可选): 图片质量 1-100,默认 90

**响应:**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "converted": [
      { "id": 1, "fileName": "image1.webp", ... },
      { "id": 2, "fileName": "image2.webp", ... }
    ],
    "errors": [
      "图片ID 3: 转换失败 - 文件损坏",
      "图片ID 4: 转换失败 - 不支持的格式"
    ]
  }
}
```

## 前端使用

### 1. API 调用

```typescript
import * as api from '@/api'

// 获取支持的格式
const formats = await api.getSupportedFormats()

// 单张转换
const result = await api.convertImageFormat(imageId, 'png', 90)

// 批量转换
const result = await api.batchConvertFormat([1, 2, 3], 'webp', 85)
```

### 2. UI 组件

新增 `FormatConverter.vue` 组件,提供图片格式转换对话框:

```vue
<FormatConverter
  v-model="showDialog"
  :image="currentImage"
  :selected-images="selectedImages"
  @converted="handleConverted"
/>
```

**Props:**
- `modelValue` - 对话框显示状态
- `image` - 单张图片对象(单张转换时)
- `selectedImages` - 图片数组(批量转换时)

**Events:**
- `converted` - 转换完成时触发,参数为转换后的图片数据

### 3. 在图片管理中使用

在 `ImageManager.vue` 中:

1. **网格视图和列表视图** - 每张图片的操作菜单中新增"格式转换"按钮
2. **点击转换按钮** - 打开格式转换对话框
3. **选择目标格式和质量** - 支持质量滑块调节(1-100)
4. **转换完成** - 自动刷新图片列表,显示转换后的图片

## 核心工具函数

### backend/utils/image.go

```go
// 支持的格式映射
var SupportedFormats = map[string]bool{
    "jpg":  true,
    "jpeg": true,
    "png":  true,
    "gif":  true,
    "webp": true,
    "bmp":  true,
    "tiff": true,
    "tif":  true,
}

// 动画格式
var AnimatedFormats = map[string]bool{
    "gif": true,
}

// 格式转换
func ConvertImageFormat(inputPath, outputPath, targetFormat string, quality int) error

// 图片优化
func OptimizeImage(inputPath, outputPath string, quality int) error

// 尺寸调整
func ResizeImage(inputPath, outputPath string, width, height int) error

// 检查格式支持
func IsSupportedFormat(ext string) bool
func IsAnimatedFormat(ext string) bool

// 获取格式列表
func GetFormatList() ([]string, []string)
```

## 使用场景

### 1. 格式统一
将不同格式的图片统一转换为相同格式,便于管理和展示。

### 2. 体积优化
- 将 PNG 转为 WebP,大幅减小文件体积
- 将 BMP 转为 JPG,减少存储空间

### 3. 兼容性处理
- 将 WebP 转为 JPG/PNG,兼容旧浏览器
- 将 TIFF 转为常见格式,便于网页展示

### 4. 质量调优
通过质量参数控制,平衡文件大小和图片质量。

## 注意事项

### 1. 动图转换
- GIF 转为静态格式(JPG/PNG/WebP等)会**丢失动画效果**
- 系统会在转换前显示警告提示

### 2. 质量建议
- **JPEG**: 建议 85-90%,过高增加体积但视觉提升不明显
- **PNG**: 建议 90-95%,作为无损格式质量影响较小
- **WebP**: 建议 85-90%,现代格式压缩效率高

### 3. 格式特性
- **PNG**: 支持透明背景,适合图标、Logo
- **WebP**: 同时支持有损和无损压缩,体积最小
- **TIFF**: 专业用途,体积大,不适合网页

### 4. 性能考虑
- 批量转换大量图片时可能耗时较长
- 建议分批处理,每批不超过50张

## 错误处理

转换失败的常见原因:
1. 文件损坏或格式不正确
2. 磁盘空间不足
3. 文件权限问题
4. 不支持的格式组合

批量转换时,成功和失败的图片会分别返回,不会因个别失败而中断整个流程。

## 未来扩展

可考虑的增强功能:
1. 支持更多格式(AVIF, HEIC等)
2. 转换时自动调整尺寸
3. 批量添加水印
4. 格式转换进度条
5. 转换前预览效果对比

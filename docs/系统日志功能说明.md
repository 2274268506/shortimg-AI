# 系统日志功能说明

## 概述

系统日志功能用于记录应用程序运行过程中的重要事件、错误和警告信息，帮助管理员监控系统健康状况和排查问题。

## 功能特性

### 1. **自动记录**
- ✅ HTTP 5xx 错误（服务器错误）
- ✅ HTTP 4xx 错误（客户端错误，仅记录 401/403/404）
- ✅ 应用程序 Panic 恢复
- ✅ 异步写入数据库，不影响请求性能

### 2. **日志级别**
- `debug` - 调试信息
- `info` - 一般信息
- `warn` - 警告信息（如 404、401、403 错误）
- `error` - 错误信息（如 5xx 错误、panic）
- `fatal` - 致命错误

### 3. **日志内容**
每条系统日志包含：
- **时间戳** - 日志记录时间
- **级别** - debug/info/warn/error/fatal
- **模块** - 日志来源模块（http、panic、database 等）
- **消息** - 日志描述信息
- **错误信息** - 详细的错误内容（可选）
- **额外信息** - JSON 格式的上下文数据（可选）
  - 请求方法、路径
  - 客户端 IP
  - HTTP 状态码
  - 响应延迟等

## 数据库结构

```sql
CREATE TABLE system_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    deleted_at DATETIME,
    level VARCHAR(20) NOT NULL,      -- 日志级别
    module VARCHAR(100) NOT NULL,    -- 模块名称
    message TEXT NOT NULL,           -- 日志消息
    error TEXT,                      -- 错误堆栈
    extra TEXT,                      -- 额外信息（JSON）
    INDEX idx_level (level),
    INDEX idx_module (module)
);
```

## API 接口

### 获取系统日志列表
```http
GET /api/logs/system
Authorization: Bearer {token}

Query Parameters:
- page: 页码（默认 1）
- pageSize: 每页数量（默认 20）
- level: 日志级别筛选（debug/info/warn/error/fatal）
- module: 模块筛选

Response:
{
  "data": [
    {
      "id": 1,
      "created_at": "2025-12-24T19:43:26Z",
      "level": "warn",
      "module": "http",
      "message": "Client error: GET /api/nonexistent-endpoint",
      "error": "",
      "extra": "{\"status\":404,\"method\":\"GET\",\"path\":\"/api/nonexistent-endpoint\",\"ip\":\"172.21.0.1\"}"
    }
  ],
  "pagination": {
    "total": 2,
    "page": 1,
    "page_size": 20
  }
}
```

### 清理旧日志
```http
POST /api/logs/clear?days=90
Authorization: Bearer {token}

Response:
{
  "message": "旧日志清理成功",
  "operation_logs_deleted": 10,
  "system_logs_deleted": 5
}
```

## 使用示例

### 在代码中记录系统日志

```go
import "imagebed/logger"

// 记录信息日志
logger.LogInfo("database", "数据库连接成功", map[string]interface{}{
    "type": "mysql",
    "host": "localhost",
})

// 记录警告日志
logger.LogWarn("storage", "存储空间不足", "剩余空间小于 10%", map[string]interface{}{
    "available": "8%",
    "threshold": "10%",
})

// 记录错误日志
logger.LogError("upload", "文件上传失败", err.Error(), map[string]interface{}{
    "filename": "example.jpg",
    "size": 1024000,
    "user_id": 1,
})

// 或使用完整方法
logger.SaveSystemLog(
    logger.LevelError,
    "auth",
    "登录失败次数过多",
    "用户被临时锁定",
    map[string]interface{}{
        "user_id": 123,
        "ip": "192.168.1.100",
        "failed_attempts": 5,
    },
)
```

## 自动记录场景

### 1. HTTP 错误自动记录
系统会自动记录以下 HTTP 错误：
- **5xx 错误**（服务器错误）- `error` 级别
  - 记录完整的请求信息和错误堆栈
- **401/403/404 错误** - `warn` 级别
  - 帮助分析认证问题和访问模式

### 2. Panic 自动记录
当应用发生 panic 时：
- 自动捕获并恢复
- 记录 `error` 级别日志
- 包含 panic 信息、请求路径、客户端 IP
- 返回 500 错误给客户端

### 3. 异步写入
所有系统日志采用异步方式写入数据库：
- 不阻塞主请求流程
- 使用 goroutine 后台写入
- 失败自动重试（通过文件日志记录）

## 前端界面

在管理后台的"日志管理"页面：

### 系统日志标签页
- ✅ 显示所有系统日志
- ✅ 按级别筛选（debug/info/warn/error/fatal）
- ✅ 按模块筛选
- ✅ 分页显示
- ✅ 彩色标签区分日志级别
- ✅ 显示完整错误信息和上下文

### 日志管理功能
- ✅ 导出日志（CSV 格式）
- ✅ 清理旧日志（默认 90 天）
- ✅ 实时刷新

## 性能优化

### 1. 异步写入
```go
go func() {
    defer func() {
        if r := recover(); r != nil {
            logger.Error("Failed to save system log", zap.Any("panic", r))
        }
    }()

    // 写入数据库
    db.Create(&systemLog)
}()
```

### 2. 选择性记录
- 只记录重要的 4xx 错误（401/403/404）
- 不记录健康检查、静态资源等常规请求
- 自动过滤日志相关的接口

### 3. 定期清理
- 系统自动清理 90 天前的旧日志
- 管理员可手动触发清理
- 清理操作在后台异步执行

## 日志级别使用建议

| 级别 | 使用场景 | 示例 |
|------|---------|------|
| `debug` | 调试信息，生产环境不记录 | 函数参数、中间变量 |
| `info` | 一般信息性事件 | 系统启动、配置加载 |
| `warn` | 警告信息，不影响功能 | 磁盘空间不足、性能下降 |
| `error` | 错误信息，需要关注 | 数据库连接失败、API 调用失败 |
| `fatal` | 致命错误，服务无法继续 | 配置文件缺失、依赖服务不可用 |

## 监控和告警

### 建议监控指标
1. **错误率**：每小时 error/fatal 级别日志数量
2. **警告趋势**：warn 级别日志增长趋势
3. **模块健康**：各模块错误分布
4. **响应时间**：从 extra 字段提取 latency_ms

### 告警设置建议
- error 级别日志 > 10 条/小时
- fatal 级别日志 > 0 条
- 特定模块错误率突增 > 50%
- panic 发生次数 > 0

## 测试

运行系统日志测试脚本：
```powershell
.\test-system-logs.ps1
```

测试内容：
- ✅ 触发 404 错误（验证 warn 日志）
- ✅ 触发 401 错误（验证 warn 日志）
- ✅ 查询系统日志列表
- ✅ 按级别筛选
- ✅ 按模块筛选

## 常见问题

### Q: 为什么没有记录所有 4xx 错误？
A: 为避免日志过多，只记录重要的 401/403/404 错误。其他 4xx 错误（如 400 参数错误）通常是客户端问题，不需要系统级别记录。

### Q: 系统日志和操作日志有什么区别？
A:
- **系统日志**：记录系统级别的错误、警告、重要事件
- **操作日志**：记录用户的业务操作（创建、更新、删除等）

### Q: 如何查看最近的错误？
A: 在前端日志管理页面，切换到"系统日志"标签，选择 level=error 筛选。

### Q: 日志会自动清理吗？
A: 是的，系统会定期清理 90 天前的日志。也可以手动触发清理。

## 后续优化建议

1. **日志聚合分析**
   - 相同错误自动聚合
   - 显示错误发生频率和趋势

2. **实时告警**
   - WebSocket 推送重要日志
   - 邮件/短信告警

3. **日志可视化**
   - 错误趋势图表
   - 模块健康度仪表板

4. **日志导出增强**
   - 支持 JSON 格式导出
   - 支持日期范围筛选

5. **日志检索优化**
   - 全文搜索
   - 复杂条件组合查询

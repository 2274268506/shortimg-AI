# 缓存清除功能测试指南

## 问题现象

1. **删除图片后仍显示**：删除图片后，刷新页面仍然能看到已删除的图片
2. **二次删除提示不存在**：再次点击删除按钮，提示"图片不存在"
3. **上传后不可见**：批量上传完成后，刷新页面看不到新上传的图片

## 根本原因

缓存键使用 MD5 哈希（如 `cache:ec01b3215ff2223393eb09a425b4afe7`），导致无法通过模式匹配精确清除特定相册的缓存。

## 解决方案（已实施）

修改 `clearImageListCache()` 函数，在图片上传/删除后清除**所有**API缓存：

```go
func clearImageListCache(albumID uint64) {
    // 清除所有API缓存以确保数据一致性
    pattern := "cache:*"
    cache.DeletePattern(pattern)
    fmt.Printf("已清除所有API缓存（相册 %d 有更新）\n", albumID)
}
```

## 手动测试步骤

### 测试1：删除功能

1. **打开前端** (http://localhost:5173)
2. **登录**（admin/admin123）
3. **查看当前图片列表**，记住图片数量（例如：5张）
4. **删除一张图片**
5. **立即刷新页面**（F5 或 Ctrl+R）
6. **验证**：
   - ✅ 图片数量应减少1（变成4张）
   - ✅ 已删除的图片不应在列表中
   - ❌ 如果仍显示已删除的图片，说明缓存未清除

### 测试2：批量上传功能

1. **准备2-3张测试图片**
2. **记住当前图片数量**（例如：4张）
3. **点击批量上传按钮**
4. **选择测试图片并上传**
5. **等待上传完成**（显示成功提示）
6. **立即刷新页面**
7. **验证**：
   - ✅ 图片数量应增加（变成6-7张）
   - ✅ 新上传的图片应立即显示
   - ❌ 如果看不到新图片，说明缓存未清除

## 检查缓存状态

### 1. 查看 Redis 缓存键

```powershell
docker exec shortimg-redis-test redis-cli KEYS "cache:*"
```

**预期结果**：
- 上传/删除操作后：应该为空或缓存键数量减少
- 如果仍有缓存键，说明清除未生效

### 2. 查看后端日志

```powershell
docker logs shortimg-backend-test --tail 50 | Select-String "清除.*缓存"
```

**预期输出**：
```
已清除所有API缓存（相册 1 有更新）
```

## 问题排查

### 问题1：删除后仍显示

**可能原因**：
1. 缓存未清除
2. Redis 未正常运行
3. 前端浏览器缓存

**排查步骤**：
```powershell
# 1. 检查 Redis 状态
docker ps --filter "name=redis"

# 2. 检查 Redis 连接
docker exec shortimg-redis-test redis-cli PING
# 应该返回：PONG

# 3. 手动清除所有缓存
docker exec shortimg-redis-test redis-cli FLUSHDB

# 4. 检查后端日志
docker logs shortimg-backend-test --tail 100
```

### 问题2：上传后不可见

**可能原因**：
1. 缓存未清除
2. 上传实际失败
3. 数据库写入延迟

**排查步骤**：
```powershell
# 1. 检查上传是否成功
docker logs shortimg-backend-test | Select-String "batch-upload"

# 2. 检查数据库
docker exec shortimg-mysql-test mysql -uimagebed_user -ptest_password_123 imagebed -se "SELECT COUNT(*) FROM images;"

# 3. 检查文件系统
docker exec shortimg-backend-test ls -l /app/uploads/album_1/

# 4. 手动测试API
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8080/api/images?albumId=1
```

### 问题3：认证错误

**症状**：删除/上传操作返回 401 或"认证令牌格式错误"

**解决**：
```powershell
# 1. 确认 token 格式正确
# Authorization: Bearer eyJhbGc...

# 2. 重新登录获取新 token
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 3. 检查 JWT 是否过期
# 默认过期时间：24小时
```

## 强制刷新方案

如果缓存清除仍有问题，可以使用以下临时方案：

### 方案1：减少缓存时间

修改 `backend/routes/routes.go`：
```go
// 从 5 分钟改为 30 秒
images.GET("", middleware.CacheMiddleware(30*time.Second), controllers.GetImages)
```

### 方案2：禁用图片列表缓存

```go
// 暂时移除缓存中间件
images.GET("", middleware.OptionalAuthMiddleware(), controllers.GetImages)
```

### 方案3：手动清除所有缓存

```powershell
# 定时任务或操作后执行
docker exec shortimg-redis-test redis-cli FLUSHDB
```

## 验证成功的标志

✅ **删除功能正常**：
- 删除后立即刷新，图片消失
- 图片数量正确减少
- 不会出现"已删除但仍显示"的情况

✅ **上传功能正常**：
- 上传后立即刷新，新图片显示
- 图片数量正确增加
- 无需等待缓存过期

✅ **日志正常**：
```
已清除所有API缓存（相册 1 有更新）
```

## 性能影响

### 当前方案（清除所有缓存）

**优点**：
- ✅ 确保数据一致性
- ✅ 实现简单
- ✅ 不会遗漏任何缓存

**缺点**：
- ⚠️ 影响所有用户的缓存
- ⚠️ 可能导致短暂性能下降

**适用场景**：
- 单用户或小型团队使用
- 图片操作频率不高
- 对实时性要求高

### 优化方案（未来）

1. **改进缓存键生成**：
   - 不使用 MD5，使用可读的原始键
   - 支持模式匹配清除

2. **缓存标签**：
   - 为每个缓存添加相册ID标签
   - 按标签批量清除

3. **主动失效**：
   - 使用 Redis Pub/Sub
   - 通知所有服务器清除缓存

## 下一步建议

1. **先测试当前方案**：验证缓存清除是否生效
2. **监控性能影响**：观察缓存命中率变化
3. **考虑优化方案**：如果性能影响大，实施更精确的清除策略

---

**更新日期**: 2025-12-07
**修复版本**: v1.1.1
**状态**: 🔧 测试中

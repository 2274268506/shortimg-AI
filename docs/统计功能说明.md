# 📊 统计功能使用说明

## 功能概述

统计功能提供了全面的图床使用数据分析，包括图片访问次数、下载次数、流量统计等关键指标，帮助您了解图床的使用情况。

## 主要功能

### 1. 总览统计

在统计页面顶部，显示四个核心指标卡片：

- **总图片数**：当前图床中的所有图片总数
- **总访问次数**：所有图片的累计访问次数
- **总下载次数**：所有图片的累计下载次数
- **总存储空间**：所有图片占用的总存储空间

### 2. 今日数据

实时展示当天的统计数据：

- 访问次数：今日图片被查看的次数
- 下载次数：今日图片被下载的次数
- 上传图片：今日新上传的图片数量
- 流量消耗：今日产生的总流量

### 3. 相册统计

按相册分组显示统计信息：

- 每个相册的图片数量
- 相册总大小
- 相册的总访问次数

### 4. 访问趋势图表

可视化展示历史趋势数据：

- 支持查看最近 7 天或 30 天的趋势
- 包含访问次数、下载次数、上传数量三条曲线
- 使用 ECharts 图表库实现平滑的折线图

### 5. 热门图片 TOP 10

展示访问量最高的前 10 张图片：

- 显示缩略图预览
- 文件名
- 访问次数（绿色标签）
- 下载次数（橙色标签）
- 文件大小
- 最后访问时间

### 6. 图片详情统计

在图片预览对话框中查看单张图片的统计：

- 访问次数
- 下载次数
- 最后访问时间

## 自动统计机制

### 访问统计

当用户通过以下方式查看图片时，系统会自动记录访问次数：

1. 在图片管理页面点击"查看"按钮
2. 打开图片预览对话框

**实现原理**：
- 前端在打开预览对话框时调用 `recordView(imageId)` API
- 后端原子性地增加 `view_count` 字段
- 更新 `last_view_at` 时间戳
- 同时更新当天的 Statistics 记录

### 下载统计

当用户下载图片时，系统会自动记录：

1. 下载次数增加
2. 流量统计增加（按图片文件大小）

**实现原理**：
- 前端在执行下载操作前调用 `recordDownload(imageId)` API
- 后端原子性地增加 `download_count` 字段
- 在当天的 Statistics 记录中增加 `total_traffic`

## 数据库设计

### Image 表新增字段

```go
ViewCount    int64      `json:"viewCount"`      // 访问次数
DownloadCount int64     `json:"downloadCount"`  // 下载次数
LastViewAt   *time.Time `json:"lastViewAt"`     // 最后访问时间
```

### Statistics 表

每日聚合统计数据：

```go
Date          string    `gorm:"uniqueIndex" json:"date"`  // 日期 (YYYY-MM-DD)
TotalViews    int64     `json:"totalViews"`               // 当日访问次数
TotalDownloads int64    `json:"totalDownloads"`           // 当日下载次数
TotalUploads  int64     `json:"totalUploads"`             // 当日上传数量
TotalTraffic  int64     `json:"totalTraffic"`             // 当日流量（字节）
UniqueIPs     int       `json:"uniqueIPs"`                // 当日独立IP数
```

## API 接口

### 1. 获取统计数据

```
GET /api/statistics
```

返回：
- overview：总览数据
- today：今日数据
- recent7Days：最近 7 天数据
- recent30Days：最近 30 天数据
- topImages：热门图片 TOP 10
- albumStats：相册统计

### 2. 记录访问

```
POST /api/statistics/view/:id
```

参数：
- id：图片 ID

### 3. 记录下载

```
POST /api/statistics/download/:id
```

参数：
- id：图片 ID

### 4. 获取单张图片统计

```
GET /api/statistics/image/:id
```

参数：
- id：图片 ID

返回：
- viewCount：访问次数
- downloadCount：下载次数
- lastViewAt：最后访问时间

## 前端实现

### 统计页面组件

**文件位置**：`frontend/src/views/Statistics.vue`

**主要功能**：
- 加载和展示统计数据
- ECharts 图表渲染
- 支持 7 天/30 天切换
- 响应式布局设计

### 集成点

**ImagePreviewDialog.vue**：
- 打开对话框时自动调用 `recordView()`
- 加载并显示图片统计数据

**useImageOperations.js**：
- 下载图片时自动调用 `recordDownload()`

### 导航入口

在顶部工具栏添加了两个导航链接：
- 资源管理（默认页面）
- 使用统计（新增）

## 数据刷新

- 统计页面在加载时会获取最新数据
- 图片预览时会实时获取该图片的最新统计
- 后端使用原子操作确保计数准确性

## 性能优化

1. **数据库索引**：
   - 在 `view_count` 和 `download_count` 字段上建立索引
   - Statistics 表的 `date` 字段有唯一索引

2. **原子操作**：
   - 使用 GORM 的 `gorm.Expr("view_count + 1")` 避免竞态条件

3. **批量聚合**：
   - 使用数据库聚合函数计算总数，而非代码循环

4. **缓存策略**（可选扩展）：
   - 可以添加 Redis 缓存热点数据
   - 定时任务预聚合统计数据

## 未来扩展建议

1. **独立 IP 统计**：
   - 在 recordView 中记录 IP 地址
   - 使用 Redis Set 统计每日独立访客

2. **图表增强**：
   - 添加饼图显示相册占比
   - 添加柱状图显示热门时段

3. **导出功能**：
   - 支持导出 Excel 统计报表
   - 支持导出 CSV 数据

4. **实时统计**：
   - WebSocket 实时推送统计更新
   - 实时在线访问人数

5. **更细粒度统计**：
   - 按小时统计访问峰值
   - 按地理位置统计访问来源
   - 按设备类型统计

## 故障排查

### 统计数据不更新

1. 检查后端服务是否正常运行
2. 查看浏览器控制台是否有 API 错误
3. 检查数据库连接是否正常

### 图表不显示

1. 确认 ECharts 库已正确安装
2. 检查浏览器控制台是否有 JavaScript 错误
3. 确认数据格式正确

### 访问/下载计数不准确

1. 检查是否有多个后端实例（需要分布式锁）
2. 确认数据库事务正常提交
3. 查看后端日志是否有错误

## 使用建议

1. **定期查看统计**：
   - 每周查看趋势图，了解使用模式
   - 关注热门图片，优化存储策略

2. **流量管理**：
   - 监控每日流量消耗
   - 对高流量图片考虑 CDN 加速

3. **存储优化**：
   - 定期清理低访问量图片
   - 压缩高访问量大文件

4. **用户体验**：
   - 根据访问峰值调整服务器资源
   - 优化热门图片的加载速度

# 用户管理功能测试指南

## 准备工作

### 1. 启动后端服务

```powershell
# 使用 Docker Compose（推荐）
cd C:\Users\DXY\Documents\shortimg-AI
docker-compose -f docker-compose.mysql-test.yml up -d

# 或直接运行编译好的二进制文件
.\bin\backend-windows-amd64.exe
```

### 2. 启动前端开发服务器

```powershell
cd frontend
npm run dev
```

### 3. 管理员登录

使用管理员账号登录：
- 用户名：`admin`
- 密码：`admin123`

## 功能测试清单

### ✅ 1. 批量操作功能

#### 批量启用
1. 进入"用户管理"页面
2. 勾选一个或多个状态为"禁用"的用户
3. 点击"批量启用"按钮
4. 确认操作
5. **预期结果**：选中用户状态变为"启用"，显示成功提示

#### 批量禁用
1. 勾选一个或多个状态为"启用"的用户（不包括当前登录的管理员）
2. 点击"批量禁用"按钮
3. 确认操作
4. **预期结果**：选中用户状态变为"禁用"，显示成功提示

#### 批量禁用（包含自己）
1. 勾选包含当前管理员在内的多个用户
2. 点击"批量禁用"按钮
3. **预期结果**：系统自动过滤掉当前管理员，只禁用其他用户

#### 批量删除
1. 勾选一个或多个用户（不包括当前登录的管理员）
2. 点击"批量删除"按钮
3. 确认操作
4. **预期结果**：选中用户被删除，显示成功提示

#### 批量删除（包含自己）
1. 勾选包含当前管理员在内的多个用户
2. 点击"批量删除"按钮
3. **预期结果**：系统自动过滤掉当前管理员，只删除其他用户

### ✅ 2. 创建用户功能

#### 正常创建
1. 点击"新建用户"按钮
2. 填写表单：
   - 用户名：`testuser01`
   - 邮箱：`test01@example.com`
   - 密码：`password123`
   - 确认密码：`password123`
   - 角色：`普通用户`
3. 点击"创建"按钮
4. **预期结果**：用户创建成功，列表中出现新用户

#### 用户名重复
1. 点击"新建用户"按钮
2. 使用已存在的用户名（如 `admin`）
3. 点击"创建"按钮
4. **预期结果**：显示"用户名已存在"错误提示

#### 邮箱重复
1. 点击"新建用户"按钮
2. 使用已存在的邮箱
3. 点击"创建"按钮
4. **预期结果**：显示"邮箱已被使用"错误提示

#### 密码不一致
1. 点击"新建用户"按钮
2. 输入不一致的密码和确认密码
3. 点击"创建"按钮
4. **预期结果**：显示"两次输入的密码不一致"提示

#### 密码长度不足
1. 点击"新建用户"按钮
2. 输入少于6位的密码（如 `12345`）
3. 点击"创建"按钮
4. **预期结果**：显示"密码长度至少为 6 位"提示

### ✅ 3. 编辑用户功能

#### 正常编辑
1. 点击某个用户的"编辑"按钮
2. 修改用户信息：
   - 用户名：修改为新的用户名
   - 邮箱：修改为新的邮箱
   - 个人简介：输入一些文字
3. 点击"保存"按钮
4. **预期结果**：用户信息更新成功，列表刷新

#### 用户名冲突
1. 点击某个用户的"编辑"按钮
2. 将用户名修改为其他用户已使用的用户名
3. 点击"保存"按钮
4. **预期结果**：显示"用户名已被使用"错误提示

#### 邮箱冲突
1. 点击某个用户的"编辑"按钮
2. 将邮箱修改为其他用户已使用的邮箱
3. 点击"保存"按钮
4. **预期结果**：显示"邮箱已被使用"错误提示

### ✅ 4. 用户详情展示

#### 查看用户详情
1. 点击某个用户的"详情"按钮
2. **预期结果**：弹出详情对话框，显示：
   - 基本信息（ID、用户名、邮箱、角色、状态等）
   - 统计信息（图片数量、相册数量、存储空间、浏览量、下载量）
   - 最近上传的图片（如果有）

#### 查看用户最近图片
1. 选择一个上传过图片的用户，点击"详情"
2. 滚动到"最近上传的图片"部分
3. **预期结果**：
   - 显示最多6张图片的缩略图
   - 显示图片名称、大小、上传时间
   - 点击图片可预览大图

#### 查看无图片用户
1. 选择一个从未上传图片的用户，点击"详情"
2. **预期结果**：在"最近上传的图片"部分显示"暂无图片"

### ✅ 5. 用户导出功能

#### 导出用户列表
1. 点击"导出用户"按钮
2. **预期结果**：
   - 浏览器自动下载 CSV 文件
   - 文件名格式：`用户列表_2024-12-24.csv`
   - 用 Excel 打开文件，中文正常显示
   - 包含所有用户信息（ID、用户名、邮箱、角色、状态等）

#### 验证导出数据
1. 打开导出的 CSV 文件
2. 检查数据完整性：
   - 表头正确（ID、用户名、邮箱等）
   - 用户数量与列表一致
   - 中文显示正常
   - 特殊字符（如引号、逗号）处理正确

### ✅ 6. 其他现有功能

#### 搜索功能
1. 在搜索框输入用户名或邮箱关键词
2. 按回车或点击搜索
3. **预期结果**：列表只显示匹配的用户

#### 状态筛选
1. 选择状态筛选器（全部/启用/禁用）
2. **预期结果**：列表只显示对应状态的用户

#### 角色筛选
1. 选择角色筛选器（全部/管理员/普通用户）
2. **预期结果**：列表只显示对应角色的用户

#### 分页功能
1. 如果用户超过20个，测试翻页
2. 修改每页显示数量
3. **预期结果**：分页正常工作

#### 启用/禁用单个用户
1. 点击某个用户的"禁用"或"启用"按钮
2. 确认操作
3. **预期结果**：用户状态改变

#### 设为管理员
1. 点击某个普通用户的"设为管理员"按钮
2. 确认操作
3. **预期结果**：用户角色变为管理员

#### 重置密码
1. 点击某个用户的"重置密码"按钮
2. 输入新密码和确认密码
3. 点击"确定"
4. **预期结果**：密码重置成功

#### 删除单个用户
1. 点击某个用户（非当前管理员）的"删除"按钮
2. 确认操作
3. **预期结果**：用户被删除

## API 测试

### 使用 PowerShell 测试

```powershell
# 设置 API 基础 URL 和认证令牌
$baseUrl = "http://localhost:8080/api"
$token = "YOUR_ADMIN_TOKEN"

# 1. 创建用户
$createUserBody = @{
    username = "apitest01"
    email = "apitest01@example.com"
    password = "password123"
    role = "user"
} | ConvertTo-Json

Invoke-RestMethod -Uri "$baseUrl/users" `
    -Method POST `
    -Headers @{Authorization="Bearer $token"} `
    -ContentType "application/json" `
    -Body $createUserBody

# 2. 更新用户信息（假设用户ID为5）
$updateUserBody = @{
    username = "apitest01_updated"
    email = "apitest01_updated@example.com"
    bio = "API测试用户"
} | ConvertTo-Json

Invoke-RestMethod -Uri "$baseUrl/users/5" `
    -Method PUT `
    -Headers @{Authorization="Bearer $token"} `
    -ContentType "application/json" `
    -Body $updateUserBody

# 3. 获取用户最近图片（假设用户ID为5）
Invoke-RestMethod -Uri "$baseUrl/users/5/images?limit=6" `
    -Method GET `
    -Headers @{Authorization="Bearer $token"}

# 4. 获取用户详情
Invoke-RestMethod -Uri "$baseUrl/users/5" `
    -Method GET `
    -Headers @{Authorization="Bearer $token"}

# 5. 删除用户
Invoke-RestMethod -Uri "$baseUrl/users/5" `
    -Method DELETE `
    -Headers @{Authorization="Bearer $token"}
```

### 使用 curl 测试

```bash
# 1. 创建用户
curl -X POST http://localhost:8080/api/users \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "curltest01",
    "email": "curltest01@example.com",
    "password": "password123",
    "role": "user"
  }'

# 2. 更新用户信息
curl -X PUT http://localhost:8080/api/users/5 \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "curltest01_updated",
    "email": "curltest01_updated@example.com",
    "bio": "curl测试用户"
  }'

# 3. 获取用户最近图片
curl -X GET "http://localhost:8080/api/users/5/images?limit=6" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# 4. 删除用户
curl -X DELETE http://localhost:8080/api/users/5 \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## 常见问题

### Q1: 批量操作时提示"无法禁用/删除自己的账号"
**A**: 这是正常的安全机制。系统会自动过滤掉当前登录的管理员账号，只对其他用户执行批量操作。

### Q2: 创建用户时提示"用户名已存在"
**A**: 检查是否有其他用户使用了相同的用户名。用户名必须唯一。

### Q3: 导出的 CSV 文件在 Excel 中中文显示乱码
**A**: 这不应该发生，因为代码已经添加了 UTF-8 BOM。如果仍然乱码，请确保使用 Excel 2016 或更高版本打开文件。

### Q4: 用户详情中看不到最近上传的图片
**A**: 检查该用户是否真的上传过图片。如果上传过但看不到，检查浏览器控制台是否有错误信息。

### Q5: 编辑用户后信息没有更新
**A**: 点击保存后，列表会自动刷新。如果没有更新，手动点击"刷新"按钮。

## 性能测试建议

### 大量用户测试
创建100+用户，测试：
- 列表加载速度
- 搜索响应时间
- 批量操作耗时
- 分页性能

### 并发操作测试
多个管理员同时操作：
- 同时创建用户
- 同时编辑同一用户
- 同时删除用户

### 边界测试
- 用户名长度边界（3-50个字符）
- 邮箱格式验证
- 密码长度验证
- 批量操作上限

## 测试报告模板

```
测试日期：2024-12-24
测试人员：
测试环境：本地开发环境 / 测试服务器 / 生产环境

| 功能模块 | 测试项 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|--------|---------|---------|-----|------|
| 批量操作 | 批量启用 | 用户状态变为启用 | ✅ | 通过 | |
| 批量操作 | 批量禁用 | 用户状态变为禁用 | ✅ | 通过 | |
| 批量操作 | 批量删除 | 用户被删除 | ✅ | 通过 | |
| 创建用户 | 正常创建 | 用户创建成功 | ✅ | 通过 | |
| 创建用户 | 用户名重复 | 提示错误 | ✅ | 通过 | |
| 编辑用户 | 正常编辑 | 信息更新成功 | ✅ | 通过 | |
| 用户详情 | 查看详情 | 显示完整信息 | ✅ | 通过 | |
| 用户详情 | 最近图片 | 显示图片列表 | ✅ | 通过 | |
| 导出功能 | 导出CSV | 文件下载成功 | ✅ | 通过 | |

发现的问题：
1. 无

优化建议：
1. 可以考虑添加用户活动日志功能
2. 可以添加批量导入用户功能
```

## 总结

所有新增功能都已实现并可以测试。请按照上述测试清单逐项测试，确保每个功能都正常工作。如果发现任何问题，请记录详细的重现步骤和错误信息。

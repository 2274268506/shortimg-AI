version: '3.8'

services:
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: shortimg-mysql-test
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: test_root_password_123
      MYSQL_DATABASE: imagebed
      MYSQL_USER: imagebed_user
      MYSQL_PASSWORD: test_password_123
    ports:
      - "3307:3306" # 映射到宿主机的3307端口,避免与现有MySQL冲突
    volumes:
      - mysql_test_data:/var/lib/mysql
      - ./backend/sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    networks:
      - shortimg-test
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存服务 (可选)
  redis:
    image: redis:7-alpine
    container_name: shortimg-redis-test
    restart: unless-stopped
    ports:
      - "6380:6379" # 映射到宿主机的6380端口
    volumes:
      - redis_test_data:/data
    networks:
      - shortimg-test
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: shortimg-backend-test
    restart: unless-stopped
    ports:
      - "8080:8080" # 映射到宿主机的8080端口
    environment:
      # 数据库配置
      DB_TYPE: mysql
      DB_DSN: imagebed_user:test_password_123@tcp(mysql:3306)/imagebed?charset=utf8mb4&parseTime=True&loc=Local

      # Redis 配置
      REDIS_ENABLED: "true"
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ""
      REDIS_DB: 0
      CACHE_TTL: 10m

      # 服务器配置
      SERVER_PORT: 8080
      SERVER_MODE: debug

      # JWT 配置
      JWT_SECRET: test-jwt-secret-key-for-mysql-testing-32chars-min
      JWT_EXPIRATION: 24h

      # 用户管理
      ALLOW_REGISTRATION: "true"

      # 默认管理员账户配置
      DEFAULT_ADMIN_USERNAME: admin
      DEFAULT_ADMIN_PASSWORD: admin123
      DEFAULT_ADMIN_EMAIL: admin@example.com

      # 文件上传
      UPLOAD_PATH: /app/uploads
      MAX_FILE_SIZE: 100

      # 存储配置
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/uploads
      STORAGE_BASE_URL: /api/files

      # 日志配置
      LOG_PATH: /app/logs/app.log
      LOG_MAX_SIZE: 100
      LOG_MAX_AGE: 30
      LOG_MAX_BACKUPS: 10

      # 短链服务配置
      SHORT_LINK_ENABLED: "true"
      SHORT_LINK_BASE_URL: http://192.168.9.5 # 后端调用 API 用(宿主机IP)
      SHORT_LINK_PUBLIC_URL: http://localhost # 浏览器访问用
      SHORT_LINK_EXPIRE: "0"
      SHORT_LINK_API_KEY: "test-api-key-12345"

      # 注意: Windows Docker Desktop 需要在 Settings -> Resources -> Network
      # 中启用 "Use kernel networking for UDP" 才能使 host.docker.internal 正常工作

      # CORS 跨域配置
      CORS_ENABLED: "true"
      CORS_ALLOW_ORIGINS: http://localhost:5173,http://localhost:5174,http://localhost:3000,http://127.0.0.1:5173
      CORS_ALLOW_METHODS: GET,POST,PUT,PATCH,DELETE,OPTIONS
      CORS_ALLOW_HEADERS: Origin,Content-Type,Accept,Authorization
    volumes:
      - backend_test_uploads:/app/uploads
      - backend_test_logs:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shortimg-test
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "-O", "/dev/null", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  shortimg-test:
    driver: bridge

volumes:
  mysql_test_data:
    name: shortimg_mysql_test_data
  redis_test_data:
    name: shortimg_redis_test_data
  backend_test_uploads:
    name: shortimg_backend_test_uploads
  backend_test_logs:
    name: shortimg_backend_test_logs

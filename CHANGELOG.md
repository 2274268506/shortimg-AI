# 更新日志

## v1.6.0 - 存储扩展版本 (2025-01-XX) 🆕

### 🎉 新增功能

#### 存储类型扩展
- ✅ **WebDAV存储支持**
  - 支持坚果云、NextCloud、ownCloud等WebDAV服务
  - 应用密码认证机制
  - 自动路径清理防止路径遍历攻击
  - 依赖: `github.com/studio-b12/gowebdav v0.11.0`

- ✅ **SFTP存储支持**
  - 支持VPS、云服务器SSH文件传输
  - 密码和SSH密钥双认证模式
  - 支持ED25519和RSA密钥格式
  - 自动创建远程目录
  - 依赖: `github.com/pkg/sftp v1.13.10`, `golang.org/x/crypto/ssh`

#### 配置增强
- ✅ **注册控制** - 新增 `ALLOW_REGISTRATION` 配置项，支持关闭用户注册
- ✅ **API认证** - 短链服务支持 API Key 认证 (`SHORT_LINK_API_KEY`)
- ✅ **存储配置** - 完善所有7种存储类型的环境变量配置

#### 短链服务优化
- ✅ **GeoIP智能路由** - 支持根据用户IP自动选择最优CDN节点
- ✅ **NAT环境支持** - 支持 `CDN_ROUTING_MODE` 强制路由模式 (auto/public/private)
- ✅ **X-Forwarded-For** - 支持多层代理的真实IP获取
- ✅ **私有IP检测** - 自动识别内网IP (10.x, 172.16-31.x, 192.168.x, 127.x)

#### 前端改进
- ✅ **Toast通知** - 替换阻塞式 alert 为非阻塞 toast 通知
- ✅ **自动隐藏** - 2秒后自动消失，不干扰用户操作
- ✅ **颜色编码** - 成功/错误/信息用不同颜色区分

### 🐛 Bug修复
- 🔧 修复 Dashboard 重复变量声明错误 (`currentStep`)
- 🔧 修复 Docker 卷挂载只读问题（移除 `:ro` 标志）
- 🔧 修复 NAT 环境下 GeoIP 路由错误重定向到 localhost

### 📚 文档更新
- 📖 更新 `STORAGE_GUIDE.md` - 添加 WebDAV 和 SFTP 详细配置
- 📖 新增测试脚本 `test_storage.sh` 和 `test_storage.ps1`
- 📖 更新 `.env` 模板，包含所有存储类型完整示例
- 📖 补充安全建议和常见问题排查指南

### 🔨 技术改进
- ⚙️ **存储接口统一** - 所有存储类型实现相同的 `Storage` 接口
- ⚙️ **配置解耦** - 使用 map 传递配置避免循环依赖
- ⚙️ **类型转换增强** - `getIntFromMap` 支持 int/int64/float64/string 多种类型
- ⚙️ **路径安全** - WebDAV 和 SFTP 实现路径清理防止攻击

### 📦 依赖更新
```bash
# 新增依赖
go get github.com/studio-b12/gowebdav@v0.11.0
go get github.com/pkg/sftp@v1.13.10
go get golang.org/x/crypto/ssh
```

### 📊 存储类型对比

| 存储类型 | 协议 | 适用场景 | 配置难度 | 推荐指数 |
|---------|------|---------|---------|---------|
| 本地 | File | 开发/测试 | ⭐ 简单 | ⭐⭐⭐ |
| OSS | HTTP | 阿里云用户 | ⭐⭐ 中等 | ⭐⭐⭐⭐ |
| COS | HTTP | 腾讯云用户 | ⭐⭐ 中等 | ⭐⭐⭐⭐ |
| 七牛 | HTTP | 国内CDN | ⭐⭐ 中等 | ⭐⭐⭐⭐ |
| S3/MinIO | HTTP | 国际/自建 | ⭐⭐⭐ 复杂 | ⭐⭐⭐⭐ |
| WebDAV | HTTP | 个人网盘 | ⭐⭐ 中等 | ⭐⭐⭐⭐ 🆕 |
| SFTP | SSH | VPS部署 | ⭐⭐⭐ 复杂 | ⭐⭐⭐⭐⭐ 🆕 |

---

## v1.5.2 - 网格视图文本溢出修复 (2025-12-03)

### 🐛 Bug 修复

#### 网格视图文本溢出彻底修复 ✅
- **问题**: 文件名和文件大小（如 "1.4 MB"）超出图片卡片边界
- **根本原因**: Flexbox 布局中缺少 `min-width: 0` 导致文本无法正确收缩
- **解决方案**:
  - 为 `.image-card` 添加 `display: flex; flex-direction: column`
  - 为 `.image-info` 添加 `min-width: 0; flex-shrink: 0`
  - 为文本元素添加 `max-width: 100%` 确保不超出父容器

### 🎨 UI 改进
- 图片卡片现在使用 Flexbox 布局，更加稳定
- 文本溢出处理更加可靠
- 所有文本都能正确显示省略号

---

## v1.5.1 - UI 修复版本 (2025-12-03)

### 🐛 Bug 修复

#### 列表视图显示修复 ✅
- **修复列表视图条件判断**: 将 `v-else` 改为 `v-else-if="viewMode === 'list'"`
- **调整加载更多按钮位置**: 移至列表视图和网格视图之后
- **确保数据正确显示**: 列表视图现在可以正常显示图片数据

#### 文本溢出修复 ✅
- **文件名溢出**: 添加省略号显示
- **文件大小溢出**: 添加文本溢出处理，防止超出卡片边界
- **图片信息容器**: 添加 width: 100% 和 box-sizing 确保正确布局

### 🎨 UI 改进
- 图片卡片信息区域布局优化
- 文本溢出时显示省略号
- 改进整体视觉一致性

---

## v1.5.0 - 分页与排序优化 (2025-12-03)

### 🔧 重大修复

#### 修复排序与分页逻辑冲突 ✅
- **后端排序**: 排序逻辑从前端移至后端，确保分页数据正确
- **性能优化**: 数据库层面排序，避免前端大量数据处理
- **参数支持**: 新增 `sortBy` (time/name/size) 和 `order` (asc/desc) 查询参数

#### 分页功能完善 ✅
- **后端分页**: 支持 `page` 和 `pageSize` 参数
- **总数统计**: 返回数据总量用于前端分页控制
- **加载更多**: 前端"加载更多"按钮，显示已加载/总数状态
- **图片懒加载**: 使用 `loading="lazy"` 优化图片加载性能

### 🎨 UI/UX 改进
- 排序选择器与分页配合无缝
- 加载更多按钮显示加载状态
- 所有图片都已加载时禁用按钮

### 🐛 Bug 修复
- 修复前端排序导致分页数据混乱的问题
- 移除可能导致无限循环的 watch 监听
- 修复 Axios 响应数据解析问题

---

## v1.4.0 - 拖拽上传与排序功能 (2025-12-03)

### 🎉 新增功能

#### 拖拽上传 ✅
- **直接拖拽**: 拖拽图片文件到页面任意位置即可上传
- **可视化反馈**: 拖拽时显示蓝色高亮边框和提示信息
- **智能上传**: 自动过滤非图片文件，上传到当前选中相册
- **进度显示**: 显示上传进度和成功数量
- **批量支持**: 支持一次拖拽多张图片

#### 图片排序 ✅
- **多种排序方式**:
  - 📅 上传时间（升序/降序）
  - 🔤 文件名（A-Z / Z-A）
  - 📦 文件大小（升序/降序）
- **实时排序**: 切换排序方式立即生效
- **持久化**: 切换相册和搜索时保持当前排序方式

### 🎨 UI/UX 改进
- 拖拽时显示优雅的提示层
- 排序选择器集成在工具栏
- 拖拽区域高亮效果
- 操作反馈更直观

### 🔧 技术优化
- 使用 watch 监听自动排序
- 优化排序算法性能
- 改进拖拽事件处理

---

## v1.3.0 - 多格式链接支持 (2025-12-03)

### 🎉 新增功能

#### 多格式链接复制 ✅
- **直接链接**: 复制图片完整 URL
- **Markdown 格式**: `![文件名](URL)` 格式
- **HTML 格式**: `<img src="URL" alt="文件名" />` 格式
- **BBCode 格式**: `[img]URL[/img]` 格式
- 支持位置：
  - 网格视图悬浮按钮
  - 列表视图操作列
  - 图片详情弹窗

### 🎨 UI/UX 改进
- 复制按钮改为下拉菜单
- 优雅的下拉菜单样式
- 一键选择不同格式
- 操作更加直观便捷

---

## v1.2.0 - 增强版本 (2025-12-03)

### 🎉 新增功能

#### 搜索功能 ✅
- 实时搜索图片
- 按文件名模糊匹配
- 切换相册自动清空搜索
- 优雅的搜索体验

#### 复制链接功能 ✅
- 一键复制图片完整 URL
- 支持现代 Clipboard API
- 包含降级方案确保兼容性
- 网格和列表视图都支持

#### 相册编辑功能 ✅
- 编辑相册名称和描述
- 保护默认相册不可编辑
- 实时更新相册列表
- 友好的编辑界面

#### 图片详情弹窗 ✅
- 左侧大图预览
- 右侧详细信息面板
- 显示文件名、尺寸、大小、格式、上传时间
- 可复制完整图片链接
- 一键下载图片

#### 相册计数修复 ✅
- 修复相册图片数量不显示问题
- 使用数据库表达式避免并发问题
- 实时同步计数确保准确性
- 批量上传也正确更新计数

### 🔧 技术改进

**后端改进：**
- 优化相册计数更新逻辑
- 使用 `gorm.Expr` 进行原子操作
- 批量上传添加缩略图生成
- 获取相册列表时实时统计图片数

**前端改进：**
- 新增 Edit 图标
- 优化图片预览对话框布局
- 改进用户交互体验
- 增强错误处理

### 🎨 UI/UX 改进
- 相册编辑按钮集成
- 图片详情双栏布局
- 信息展示更加清晰
- 操作反馈更及时

---

## v1.1.0 - 功能增强版本 (2025-12-03)

### 🎉 新增功能

#### 图片缩略图
- ✅ 自动为上传的图片生成缩略图（300px宽度）
- ✅ GIF 格式跳过缩略图生成，保留动画效果
- ✅ 新增 `/api/images/:id/thumbnail` 接口获取缩略图
- ✅ 提升图片列表加载速度

#### 搜索功能
- ✅ 支持按文件名搜索图片
- ✅ 实时搜索，输入即查询
- ✅ 支持模糊匹配
- ✅ 搜索框集成在内容头部

#### 复制链接功能
- ✅ 一键复制图片完整URL
- ✅ 支持网格视图和列表视图
- ✅ 自动复制到剪贴板
- ✅ 包含降级方案，兼容性更好

#### 上传进度显示
- ✅ 实时显示上传进度条
- ✅ 显示上传状态和提示信息
- ✅ 成功/失败状态提示
- ✅ 优化用户体验

#### 统计信息面板
- ✅ 显示当前相册图片总数
- ✅ 显示图片总大小
- ✅ 显示当前相册名称
- ✅ 美观的卡片式布局

### 🔧 技术改进

#### 后端改进
- 添加 `utils` 包用于图片处理
- 集成 `github.com/nfnt/resize` 库生成缩略图
- 优化图片控制器代码结构
- 添加文件存在性检查函数
- 支持搜索参数查询

#### 前端改进
- 新增图标：Link、Search、Document、Collection
- 优化组件状态管理
- 改进用户交互体验
- 添加统计数据计算
- 优化样式和布局

### 📦 依赖更新

**后端新增依赖：**
```
github.com/nfnt/resize v0.0.0-20180917051193-5215b49d6324
```

### 🎨 UI/UX 改进
- 搜索框集成到内容头部
- 统计面板卡片式设计
- 上传进度可视化
- 操作按钮图标优化
- 整体视觉一致性提升

### 📝 文档更新
- 更新 README.md 功能列表
- 添加新增接口文档
- 完善使用说明
- 添加更新日志

---

## v1.0.0 - 初始版本 (2025-12-03)

### 🎉 核心功能

#### 图片管理
- 单张图片上传
- 批量图片上传
- 图片预览
- 图片下载
- 图片删除
- 支持 JPG、PNG、GIF、WebP 格式

#### 相册管理
- 创建相册
- 删除相册
- 相册列表查看
- 图片在相册间移动
- 相册图片统计

#### 界面设计
- 资源管理器风格布局
- 左侧相册树
- 右侧图片展示区
- 网格视图
- 列表视图
- 拖拽上传支持

### 🛠️ 技术栈

**后端：**
- Go 1.21+
- Gin Web 框架
- GORM ORM
- SQLite 数据库

**前端：**
- Vue 3
- Vite
- Element Plus
- Pinia
- Axios

### 📦 初始依赖

**后端：**
```
github.com/gin-gonic/gin v1.9.1
github.com/gin-contrib/cors v1.5.0
gorm.io/gorm v1.25.5
gorm.io/driver/sqlite v1.5.4
github.com/google/uuid v1.5.0
```

**前端：**
```
vue: ^3.3.11
vue-router: ^4.2.5
pinia: ^2.1.7
axios: ^1.6.2
element-plus: ^2.5.1
```

---

## 🚀 即将推出

- [ ] 图片标签功能
- [ ] 图片批量操作
- [ ] 图片编辑功能
- [ ] 用户权限管理
- [ ] 外链设置
- [ ] 图片水印
- [ ] 更多图片格式支持

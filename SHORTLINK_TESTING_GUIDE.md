# 图床短链功能测试指南

## 📋 测试清单

### 前置条件
- [x] 短链服务运行正常（docker-compose ps）
- [x] Backend 已启用短链功能（.env 配置）
- [x] Frontend 已安装依赖（qrcode）
- [x] 数据库已添加 short_link_code 字段

## 🧪 测试步骤

### 1. 启动所有服务

#### 1.1 启动短链服务
```powershell
cd c:\Users\DXY\Documents\TC-GO\redirect-service
docker-compose up -d

# 验证服务状态
docker-compose ps
# 应该看到 openresty, mysql, redis 都是 Up 状态

# 测试健康检查
curl http://localhost/api/health
```

#### 1.2 启动 Backend
```powershell
cd c:\Users\DXY\Documents\TC-GO\backend

# 确保 .env 配置正确
# SHORT_LINK_ENABLED=true
# SHORT_LINK_BASE_URL=http://localhost
# SHORT_LINK_EXPIRE=0

# 启动服务
go run main.go
# 或
.\imagebed.exe
```

#### 1.3 启动 Frontend
```powershell
cd c:\Users\DXY\Documents\TC-GO\frontend

# 安装依赖（如果还没安装）
npm install
npm install qrcode @types/qrcode

# 启动开发服务器
npm run dev
```

访问 http://localhost:5173 （或 Vite 显示的端口）

### 2. 功能测试

#### 2.1 图片上传测试

**步骤**:
1. 登录图床系统
2. 点击"上传图片"按钮
3. 选择一张测试图片
4. 点击"开始上传"

**预期结果**:
- ✅ 上传成功提示
- ✅ 图片出现在列表中
- ✅ 图片数据包含 `shortLinkCode` 和 `shortLinkUrl`

**验证方法**:
打开浏览器开发者工具 → Network → 查看上传响应：
```json
{
  "id": 123,
  "fileName": "test.jpg",
  "url": "/uploads/2024/12/06/test.jpg",
  "shortLinkCode": "abc123",
  "shortLinkUrl": "http://localhost/abc123"
}
```

#### 2.2 列表视图短链测试

**步骤**:
1. 切换到列表视图（点击列表图标）
2. 找到有短链的图片
3. 查看"短链"列

**预期结果**:
- ✅ 有短链的图片显示蓝色"复制短链"按钮
- ✅ 无短链的图片显示灰色"无短链"标签

**步骤**:
4. 点击"复制短链"按钮

**预期结果**:
- ✅ 显示"短链已复制到剪贴板"提示
- ✅ 剪贴板内容为短链URL（如 `http://localhost/abc123`）

**验证方法**:
在浏览器地址栏粘贴（Ctrl+V），应该看到短链URL

#### 2.3 网格视图短链测试

**步骤**:
1. 切换到网格视图（点击网格图标）
2. 鼠标悬停在图片上
3. 查看操作按钮

**预期结果**:
- ✅ 显示多个操作按钮
- ✅ 有短链的图片显示蓝色"复制短链"按钮（Link 图标）
- ✅ 按钮位置：预览、复制链接、**复制短链**、下载

**步骤**:
4. 点击蓝色短链按钮

**预期结果**:
- ✅ 显示"短链已复制到剪贴板"提示
- ✅ 剪贴板包含正确的短链

#### 2.4 预览对话框短链测试

**步骤**:
1. 点击任意图片预览
2. 在预览对话框中滚动到底部
3. 查看"图片链接"下方

**预期结果**（有短链的图片）:
- ✅ 显示紫色渐变的短链信息卡片
- ✅ 卡片标题：🔗 短链接
- ✅ 短链URL输入框（只读）
- ✅ 复制短链按钮
- ✅ 格式化按钮组：Markdown、HTML、BBCode、二维码

**步骤**:
4. 点击"复制短链"按钮（输入框右侧）

**预期结果**:
- ✅ 显示"短链已复制到剪贴板"提示

**步骤**:
5. 点击"Markdown"按钮

**预期结果**:
- ✅ 显示"Markdown 格式已复制到剪贴板"提示
- ✅ 剪贴板内容：`![test.jpg](http://localhost/abc123)`

**步骤**:
6. 点击"HTML"按钮

**预期结果**:
- ✅ 显示"HTML 格式已复制到剪贴板"提示
- ✅ 剪贴板内容：`<img src="http://localhost/abc123" alt="test.jpg" />`

**步骤**:
7. 点击"BBCode"按钮

**预期结果**:
- ✅ 显示"BBCode 格式已复制到剪贴板"提示
- ✅ 剪贴板内容：`[img]http://localhost/abc123[/img]`

#### 2.5 二维码功能测试

**步骤**:
1. 在预览对话框的短链卡片中
2. 点击"二维码"按钮

**预期结果**:
- ✅ 弹出二维码对话框
- ✅ 显示加载动画
- ✅ 生成并显示二维码图片（200x200px）
- ✅ 二维码下方显示短链URL
- ✅ 显示"下载二维码"按钮

**步骤**:
3. 使用手机扫描二维码

**预期结果**:
- ✅ 手机识别出短链URL
- ✅ 访问短链可正常跳转到图片

**步骤**:
4. 点击"下载二维码"按钮

**预期结果**:
- ✅ 下载 PNG 文件（文件名：shortlink-abc123.png）
- ✅ 图片包含完整二维码

#### 2.6 短链重定向测试

**步骤**:
1. 复制任意图片的短链（如 `http://localhost/abc123`）
2. 在浏览器新标签页打开该短链

**预期结果**:
- ✅ 自动重定向到原始图片URL
- ✅ 显示图片内容
- ✅ 地址栏变为原始URL（如 `http://localhost:8080/uploads/...`）

**步骤**:
3. 多次访问同一短链

**预期结果**:
- ✅ 每次都能正常重定向
- ✅ 点击量增加（可在统计接口查看）

#### 2.7 批量上传短链测试

**步骤**:
1. 点击"上传图片"
2. 选择多张图片（如3张）
3. 点击"开始上传"
4. 等待上传完成

**预期结果**:
- ✅ 所有图片上传成功
- ✅ 每张图片都有独立的短链
- ✅ 短链代码各不相同

**验证方法**:
在列表/网格视图中检查每张图片的短链

### 3. 响应式测试

#### 3.1 移动端适配测试

**步骤**:
1. 打开浏览器开发者工具（F12）
2. 切换到设备模拟模式（Ctrl+Shift+M）
3. 选择移动设备（如 iPhone 12）

**预期结果 - 列表视图**:
- ✅ 短链列正常显示
- ✅ 按钮文字可能隐藏，仅显示图标
- ✅ 表格横向滚动

**预期结果 - 网格视图**:
- ✅ 图片卡片自适应宽度
- ✅ 操作按钮大小适中，易于点击

**预期结果 - 短链卡片**:
- ✅ 卡片宽度自适应
- ✅ 按钮组换行或缩小
- ✅ 文字大小适中

#### 3.2 平板适配测试

**步骤**:
1. 模拟器切换到平板（如 iPad）

**预期结果**:
- ✅ 所有功能正常
- ✅ 布局合理利用屏幕空间

### 4. 错误处理测试

#### 4.1 无短链图片测试

**步骤**:
1. 上传图片前，临时禁用短链功能：
   ```
   Backend .env: SHORT_LINK_ENABLED=false
   ```
2. 重启 Backend
3. 上传新图片

**预期结果**:
- ✅ 图片上传成功
- ✅ 列表视图显示"无短链"标签
- ✅ 网格视图不显示短链按钮
- ✅ 预览对话框不显示短链卡片

#### 4.2 短链服务停止测试

**步骤**:
1. 停止短链服务：
   ```powershell
   cd redirect-service
   docker-compose down
   ```
2. 尝试上传新图片

**预期结果**:
- ✅ 图片上传成功（短链生成失败不影响上传）
- ✅ 图片无短链信息

#### 4.3 二维码库未安装测试

**步骤**:
1. 卸载 qrcode 库：
   ```powershell
   cd frontend
   npm uninstall qrcode
   ```
2. 重启 Frontend
3. 点击"二维码"按钮

**预期结果**:
- ✅ 显示错误提示："生成二维码失败，请确保已安装 qrcode 库"
- ✅ 其他功能不受影响

### 5. 性能测试

#### 5.1 大量图片测试

**步骤**:
1. 上传 20+ 张图片
2. 切换列表/网格视图
3. 滚动浏览

**预期结果**:
- ✅ 页面流畅，无明显卡顿
- ✅ 短链按钮响应及时

#### 5.2 快速点击测试

**步骤**:
1. 快速连续点击"复制短链"按钮 5 次

**预期结果**:
- ✅ 每次点击都有提示
- ✅ 不会出现错误或崩溃

### 6. 数据一致性测试

#### 6.1 数据库验证

**步骤**:
```sql
-- 查询带短链的图片
SELECT id, file_name, short_link_code
FROM images
WHERE short_link_code IS NOT NULL
LIMIT 10;

-- 验证短链记录
SELECT short_code, long_url, click_count
FROM short_links
WHERE metadata LIKE '%imagebed%'
LIMIT 10;
```

**预期结果**:
- ✅ images 表包含 short_link_code
- ✅ short_links 表有对应记录
- ✅ long_url 指向正确的图片URL

#### 6.2 API 响应验证

**步骤**:
```powershell
# 测试图床短链 API
curl http://localhost/api/imagebed/stats

# 测试重定向
curl -I http://localhost/abc123
```

**预期结果**:
- ✅ stats 返回统计数据
- ✅ 重定向返回 302 状态码
- ✅ Location 头包含原始URL

## ✅ 测试通过标准

### 核心功能
- [x] 图片上传自动生成短链
- [x] 列表视图显示短链列
- [x] 网格视图显示短链按钮
- [x] 预览对话框显示短链卡片
- [x] 一键复制短链
- [x] 多格式复制（Markdown/HTML/BBCode）
- [x] 二维码生成和下载
- [x] 短链正常重定向

### 用户体验
- [x] 界面美观，符合设计规范
- [x] 操作流畅，无明显延迟
- [x] 提示信息清晰
- [x] 错误处理友好

### 兼容性
- [x] 桌面端正常显示
- [x] 移动端完美适配
- [x] 平板端良好体验

### 稳定性
- [x] 无 JavaScript 错误
- [x] 无控制台警告
- [x] 数据一致性正确

## 🐛 问题记录模板

### 问题描述
**标题**:
**严重程度**: 低/中/高/紧急
**复现步骤**:
1.
2.
3.

**预期结果**:

**实际结果**:

**截图**:

**环境信息**:
- 操作系统:
- 浏览器:
- Frontend 版本:
- Backend 版本:

## 📊 测试报告模板

### 测试概要
- 测试日期:
- 测试人员:
- 测试环境:
- 测试结果: 通过/失败

### 功能测试结果
| 测试项 | 状态 | 备注 |
|--------|------|------|
| 图片上传生成短链 | ✅/❌ | |
| 列表视图短链显示 | ✅/❌ | |
| 网格视图短链按钮 | ✅/❌ | |
| 预览对话框短链卡片 | ✅/❌ | |
| 复制短链功能 | ✅/❌ | |
| 多格式复制 | ✅/❌ | |
| 二维码生成 | ✅/❌ | |
| 短链重定向 | ✅/❌ | |

### 响应式测试结果
| 设备类型 | 状态 | 备注 |
|----------|------|------|
| 桌面端 (1920x1080) | ✅/❌ | |
| 平板端 (iPad) | ✅/❌ | |
| 移动端 (iPhone) | ✅/❌ | |

### 发现的问题
1.
2.
3.

### 建议
1.
2.
3.

## 🎉 测试完成

如果所有测试项都通过，恭喜！图床短链功能已完整集成并可以投入使用。

如有问题，请参考：
- [前端集成说明](FRONTEND_SHORTLINK_INTEGRATION.md)
- [Backend集成指南](IMAGEBED_INTEGRATION.md)
- [故障排查](IMAGEBED_INTEGRATION.md#故障排查)

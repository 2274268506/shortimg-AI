# 短链管理面板使用指南

## 📊 面板概览

**短链管理面板** 是专门为管理员设计的监控仪表板，提供短链服务的业务数据和运营指标。

- **访问地址**: http://localhost:3000/d/short-link-management
- **刷新频率**: 30秒自动刷新
- **默认时间范围**: 最近6小时

---

## 📈 面板详解

### 第一行：业务趋势监控

#### 1. 短链创建趋势 📊
- **位置**: 左上角 (12格宽)
- **指标**:
  - 创建成功：`rate(short_link_http_requests_total{endpoint="/api/shorten",status="200"}[5m]) * 60`
  - 客户端错误：`status=~"4.."` (如参数错误、权限不足)
  - 服务器错误：`status=~"5.."` (如数据库错误)
- **用途**:
  - 监控短链创建速率
  - 发现异常流量或攻击
  - 评估系统负载

#### 2. 短链查询趋势 📊
- **位置**: 右上角 (12格宽)
- **指标**:
  - 查询成功：返回 200 的 `/api/info` 请求
  - 短链不存在：返回 404 的请求
- **用途**:
  - 监控查询 API 使用情况
  - 分析无效短链查询比例

### 第二行：核心业务指标

#### 3. 短链总数统计 📈
- **位置**: 左侧
- **指标**: `short_link_short_links_total`
- **阈值**:
  - 🟢 绿色: <10,000
  - 🟡 黄色: 10,000 - 100,000
  - 🟠 橙色: 100,000 - 1,000,000
  - 🔴 红色: >1,000,000
- **用途**: 实时了解数据库容量

#### 4. 今日创建数 📊
- **位置**: 中间左侧
- **指标**: `increase(short_link_http_requests_total{endpoint="/api/shorten",status="200"}[24h])`
- **阈值**:
  - 🟢 绿色: <1,000
  - 🟡 黄色: 1,000 - 5,000
  - 🔴 红色: >5,000
- **用途**: 监控日增长率

#### 5. 今日访问数 🔄
- **位置**: 中间右侧
- **指标**: `increase(short_link_redirect_requests_total[24h])`
- **阈值**:
  - 🟢 绿色: <10,000
  - 🟡 黄色: 10,000 - 50,000
  - 🔴 红色: >50,000
- **用途**: 监控重定向流量

#### 6. 创建成功率 ⚡
- **位置**: 右侧
- **指标**: 成功请求数 / 总请求数 * 100
- **阈值**:
  - 🔴 红色: <90%
  - 🟡 黄色: 90% - 95%
  - 🟢 绿色: >95%
- **用途**: 评估服务质量

### 第三行：性能监控

#### 7. API 响应时间分布 ⏱️
- **位置**: 左侧 (12格宽)
- **指标**:
  - 创建 P50/P95: `/api/shorten` 端点延迟
  - 查询 P50/P95: `/api/info` 端点延迟
- **用途**:
  - 对比不同操作的性能
  - 发现性能瓶颈

#### 8. 数据库查询性能 💾
- **位置**: 右侧 (12格宽)
- **指标**:
  - SELECT P95: 查询操作延迟
  - INSERT P95: 插入操作延迟
  - UPDATE P95: 更新操作延迟
- **用途**:
  - 监控数据库性能
  - 发现慢查询问题

### 第四行：数据分析

#### 9. 热门短链 Top 10 🔥
- **位置**: 左侧 (12格宽)
- **展示**: 表格格式
- **指标**: `topk(10, rate(short_link_redirect_requests_total[1h]))`
- **用途**:
  - 发现热点数据
  - 优化缓存策略
  - 业务分析

#### 10. 短链创建来源分布 🥧
- **位置**: 右侧 (12格宽)
- **展示**: 饼图
- **指标**: 按 HTTP 方法统计（GET/POST/etc）
- **用途**: 分析 API 使用方式

### 第五行：缓存与错误

#### 11. 缓存效率 💨
- **位置**: 左侧 (12格宽)
- **指标**:
  - L1 缓存命中率（本地缓存）
  - L2 缓存命中率（Redis）
  - Redis GET 操作速率（右侧Y轴）
- **用途**:
  - 评估缓存策略
  - 优化缓存配置

#### 12. 错误类型分布 ⚠️
- **位置**: 右侧 (12格宽)
- **指标**: 按错误类型分组的错误率
- **用途**:
  - 识别常见错误
  - 优先修复问题

### 第六行：批量操作

#### 13. 批量操作统计 📦
- **指标**: `increase(short_link_http_requests_total{endpoint="/api/batch/shorten"}[1h])`
- **颜色**: 绿色
- **用途**: 监控批量创建使用情况

#### 14. 删除操作统计 🗑️
- **指标**: `increase(short_link_http_requests_total{endpoint="/api/delete"}[1h])`
- **颜色**: 蓝色
- **用途**: 监控删除操作频率

#### 15. 更新操作统计 ✏️
- **指标**: `increase(short_link_http_requests_total{endpoint="/api/update"}[1h])`
- **颜色**: 紫色
- **用途**: 监控更新操作频率

---

## 🎯 使用场景

### 场景 1: 日常运营监控

**关注面板**:
1. 短链总数统计
2. 今日创建数
3. 今日访问数
4. 创建成功率

**检查频率**: 每天早晨查看

**关键指标**:
- 创建成功率应 >95%
- 今日创建数无异常波动
- 总数增长符合预期

### 场景 2: 性能优化

**关注面板**:
1. API 响应时间分布
2. 数据库查询性能
3. 缓存效率

**优化目标**:
- API P95 延迟 <100ms
- 数据库 SELECT P95 <50ms
- 缓存命中率 >80%

### 场景 3: 故障排查

**关注面板**:
1. 错误类型分布
2. 短链创建趋势（查看错误曲线）
3. 创建成功率

**排查步骤**:
1. 检查错误类型分布，识别主要错误
2. 查看创建趋势，确定问题开始时间
3. 对比响应时间，判断是否性能问题
4. 检查数据库查询性能

### 场景 4: 业务分析

**关注面板**:
1. 热门短链 Top 10
2. 短链创建来源分布
3. 批量操作统计

**分析维度**:
- 哪些短链最受欢迎？
- 用户如何使用 API？
- 批量操作占比多少？

---

## 🔍 常用 PromQL 查询

### 查询创建失败的短链
```promql
sum(rate(short_link_http_requests_total{endpoint="/api/shorten",status!="200"}[5m])) by (status)
```

### 查询平均创建速率（每小时）
```promql
rate(short_link_http_requests_total{endpoint="/api/shorten",status="200"}[1h]) * 3600
```

### 查询最慢的 API 端点
```promql
topk(5,
  histogram_quantile(0.95,
    rate(short_link_http_request_duration_seconds_bucket[5m])
  )
) by (endpoint)
```

### 查询缓存未命中率
```promql
(1 - short_link_cache_hit_rate) * 100
```

---

## ⚙️ 自定义配置

### 调整刷新频率

1. 点击仪表板右上角的时间选择器
2. 在刷新间隔下拉菜单中选择：
   - 5s - 高频监控
   - 30s - 默认
   - 1m - 降低服务器负载
   - 5m - 趋势分析

### 调整时间范围

常用时间范围：
- **Last 1 hour**: 实时监控
- **Last 6 hours**: 默认，日常监控
- **Last 24 hours**: 日报分析
- **Last 7 days**: 周报分析
- **Last 30 days**: 月报分析

### 添加告警

1. 编辑任意面板
2. 切换到 "Alert" 标签页
3. 点击 "Create alert rule from this panel"
4. 设置告警条件：

**示例：创建成功率低告警**
```
条件: 创建成功率 < 90%
持续时间: 5分钟
严重级别: 高
通知: Email/Slack
```

---

## 📋 监控检查清单

### 每日检查
- [ ] 创建成功率 >95%
- [ ] 无异常错误峰值
- [ ] 响应时间正常 (P95 <100ms)
- [ ] 缓存命中率 >70%

### 每周检查
- [ ] 短链总数增长趋势正常
- [ ] 热门短链无异常流量
- [ ] 数据库查询性能稳定
- [ ] 批量操作无滥用

### 每月检查
- [ ] 审查长期性能趋势
- [ ] 评估缓存策略有效性
- [ ] 分析业务增长数据
- [ ] 优化慢查询

---

## 🚨 告警阈值建议

| 指标 | 警告阈值 | 严重阈值 | 建议措施 |
|-----|---------|---------|---------|
| 创建成功率 | <95% | <90% | 检查服务和数据库 |
| API P95 延迟 | >100ms | >500ms | 性能优化 |
| 缓存命中率 | <70% | <50% | 调整缓存策略 |
| 错误率 | >2% | >5% | 排查错误原因 |
| 数据库 P95 | >50ms | >200ms | 优化查询或扩容 |

---

## 🔗 相关仪表板

- **短链服务监控总览**: http://localhost:3000/d/short-link-overview
  - 侧重系统性能和健康状态

- **短链管理面板**: http://localhost:3000/d/short-link-management
  - 侧重业务数据和运营指标

**建议搭配使用**：
- 技术团队：关注监控总览
- 运营团队：关注管理面板
- 管理层：两者结合看整体状况

---

**最后更新**: 2025-12-05
**版本**: 1.0
**维护**: 短链服务团队

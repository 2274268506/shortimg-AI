# OpenResty 主配置文件

worker_processes auto;
error_log logs/error.log warn;
pid logs/nginx.pid;

events {
    worker_connections 10240;
    use epoll;
}

http {
    include mime.types;
    default_type application/octet-stream;

    # DNS 解析器配置（Docker 内部 DNS）
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 5s;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    log_format json escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"x_forwarded_for":"$http_x_forwarded_for",'
        '"x_real_ip":"$http_x_real_ip",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent"'
    '}';

    access_log logs/access.log json;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss;

    # Lua 相关配置
    lua_package_path "$prefix/lua/?.lua;;";
    lua_shared_dict short_links 200m;      # 短链缓存（优化：增大）
    lua_shared_dict health_check 50m;      # 健康检查（优化：增大）
    lua_shared_dict rate_limit 100m;       # 限流（优化：增大）
    lua_shared_dict stats 100m;            # 统计数据（优化：增大）
    lua_shared_dict link_cache 200m;       # L1 本地缓存（新增）
    lua_shared_dict metrics 100m;          # 性能指标（新增）
    lua_shared_dict prometheus_metrics 100m;  # Prometheus 指标（新增）
    lua_code_cache on;

    # Redis 连接池配置
    lua_shared_dict redis_cluster_slot_locks 100k;

    # 性能优化：增加请求和连接限制
    keepalive_requests 1000;

    # 初始化
    init_by_lua_block {
        require "core.init"
    }

    init_worker_by_lua_block {
        require "core.worker"
    }

    # 上游服务器配置
    include upstream.conf;

    # 主服务器
    server {
        listen 80;
        server_name _;

        # Prometheus 指标端点
        location = /metrics {
            access_log off;
            content_by_lua_block {
                require("api.metrics").metrics()
            }
        }

        # 健康检查端点（完整）
        location = /health {
            access_log off;
            content_by_lua_block {
                require("api.health").check()
            }
        }

        # 活跃性检查（Kubernetes liveness probe）
        location = /health/live {
            access_log off;
            content_by_lua_block {
                require("api.health").liveness()
            }
        }

        # 就绪性检查（Kubernetes readiness probe）
        location = /health/ready {
            access_log off;
            content_by_lua_block {
                require("api.health").readiness()
            }
        }

        # 短链重定向
        location ~ ^/r/([a-zA-Z0-9_-]+)$ {
            set $short_code $1;

            access_by_lua_block {
                require("core.router").access()
            }

            content_by_lua_block {
                require("core.router").redirect()
            }

            # log_by_lua_block {
            #     require("core.logger").log()
            # }
        }

        # 管理 API（需要认证）
        location /api/v1/ {
            access_by_lua_block {
                -- API 认证
                require("middleware.auth").authenticate()
                -- 速率限制：每分钟10000次请求（极高限制，基本不会触发）
                require("middleware.auth").rate_limit(10000, 60)
            }

            content_by_lua_block {
                local uri = ngx.var.uri

                -- 扩展 API 路由
                if uri:match("^/api/v1/batch/") or
                   uri:match("^/api/v1/stats/") or
                   uri:match("^/api/v1/tasks/") then
                    require("api.admin_extended").handle()
                else
                    require("api.admin").handle()
                end
            }
        }

        # 统计 API (公开访问)
        location /api/stats/ {
            content_by_lua_block {
                local uri = ngx.var.uri
                local method = ngx.var.request_method

                if method ~= "GET" then
                    ngx.status = 405
                    ngx.say('{"success":false,"error":"仅支持GET请求"}')
                    return
                end

                -- GET /api/stats/overview - 总体统计
                if uri == "/api/stats/overview" then
                    require("api.stats_enhanced").get_overview()

                -- GET /api/stats/service/{service_type} - 服务类型统计
                elseif uri:match("^/api/stats/service/") then
                    local service_type = uri:match("^/api/stats/service/(.+)$")
                    require("api.stats_enhanced").get_by_service(service_type)

                -- GET /api/stats/access - 访问日志统计
                elseif uri == "/api/stats/access" then
                    require("api.stats_enhanced").get_access_stats()

                -- 原有统计API保持兼容
                else
                    require("api.stats").handle()
                end
            }
        }

        # 管理 API (需要认证)
        location /api/admin/ {
            access_by_lua_block {
                -- API 认证（可以启用）
                -- require("middleware.auth").authenticate()
                -- 速率限制
                -- require("middleware.auth").rate_limit(100, 60)
            }

            content_by_lua_block {
                local uri = ngx.var.uri

                -- 批量管理 API
                if uri:match("^/api/admin/batch/") or
                   uri:match("^/api/admin/cleanup/") or
                   uri == "/api/admin/links" then
                    require("api.admin_batch").handle()
                -- 其他管理 API
                else
                    require("api.admin").handle()
                end
            }
        }

        # 规则热更新
        location /api/reload {
            content_by_lua_block {
                require("core.reload").execute()
            }
        }

        # Favicon
        location = /favicon.ico {
            alias html/favicon.svg;
            add_header Content-Type image/svg+xml;
            access_log off;
        }

        location = /favicon.svg {
            alias html/favicon.svg;
            add_header Content-Type image/svg+xml;
            access_log off;
        }

        # 监控面板
        location /dashboard {
            alias html/dashboard/;
            index index.html;
        }

        # 短链重定向 - 处理所有短链码（支持连字符，如 img-xxxxxxxxxxxx）
        location ~ ^/([a-zA-Z0-9\-]+)$ {
            set $short_code $1;
            content_by_lua_block {
                require("core.router").redirect()
            }
        }

        # 404 处理
        location / {
            return 404 "Not Found\n";
        }
    }

    # HTTPS 服务器（可选）
    # server {
    #     listen 443 ssl http2;
    #     server_name _;
    #
    #     ssl_certificate /path/to/cert.pem;
    #     ssl_certificate_key /path/to/key.pem;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #
    #     # 其他配置同上
    # }
}

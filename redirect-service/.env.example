# ========================================
# 🚀 TC-GO 短链重定向服务配置
# ========================================
# 📝 使用说明:
#   1. 复制此文件为 .env
#   2. 配置CDN节点域名和协议
#   3. 在 routing_rules.yaml 中配置分流规则
#   4. 重启服务生效
#
# 💡 配置流程:
#   第一步: 配置下方的基础服务信息（域名、数据库、Redis）
#   第二步: 配置CDN节点信息（域名、协议、端口）
#   第三步: 编辑 routing_rules.yaml 设置分流规则
#   第四步: 运行验证脚本检查配置
#   第五步: 重启服务应用配置
#
# 🔧 验证配置:
#   Linux/Mac:  ./scripts/validate_config.sh
#   Windows:    .\scripts\validate_config.ps1
#
# 📖 详细文档:
#   - 快速入门: ROUTING_QUICK_START.md
#   - 完整指南: ROUTING_CONFIG_GUIDE.md
#   - CDN节点配置: CDN_NODES_GUIDE.md
#   - 路由规则说明: ROUTING_README.md
# ========================================

# ========================================
# 🌐 短链服务基础配置
# ========================================
# 短链访问域名（用户访问的短链地址）
# 示例:
#   - 开发环境: localhost 或 127.0.0.1
#   - 生产环境: s.yourdomain.com
# 注意: 不包含协议(http/https)和端口号
REDIRECT_DOMAIN=short.example.com

# 短链访问协议: http 或 https
# 生产环境强烈建议使用 https
REDIRECT_PROTOCOL=https

# ========================================
# 📡 路由配置文件
# ========================================
# 路由规则配置文件路径（YAML格式）
# 所有分流规则都在此文件中定义
ROUTING_CONFIG_FILE=/usr/local/openresty/nginx/conf/routing_rules.yaml
#
# 💡 routing_rules.yaml 支持:
#   ✅ 多条件组合匹配（IP+地理位置+运营商+时间+路径等）
#   ✅ 优先级控制（1-999，数字越小优先级越高）
#   ✅ 灵活启用/禁用规则（enabled: true/false）
#   ✅ A/B测试、灰度发布（百分比分流）
#   ✅ 降级容错机制（fallback_chain）
#   ✅ 热更新支持（修改后自动生效，缓存默认5分钟）
#
# 📋 支持的10种分流条件（可组合使用）:
#   1. ip_range:     IP地址段匹配（内网/外网识别）
#   2. province:     省份匹配（华北/华南/华东等）
#   3. isp:          运营商匹配（电信/联通/移动）
#   4. country:      国家匹配（国内/海外分流）
#   5. asn:          ASN匹配（精确运营商识别）
#   6. path_prefix:  URL路径匹配（图床/API分离）
#   7. time_range:   时间段匹配（峰谷分流/维护窗口）
#   8. percentage:   百分比分流（A/B测试/灰度）
#   9. header:       HTTP头匹配（客户端指定CDN）
#   10. query_param: URL参数匹配（动态CDN选择）

# ========================================
# 📡 CDN节点配置
# ========================================
# 说明:
#   - 以下配置的CDN节点可在 routing_rules.yaml 中引用
#   - 格式: CDN_{节点ID大写}_DOMAIN/PROTOCOL/PORT
#   - 可以自由增减节点，详见 CDN_NODES_GUIDE.md
#
# 📋 默认节点列表（8个）:
#   - private:  私有网络（内网/开发）
#   - unicom:   联通CDN（中国联通用户优化）
#   - mobile:   移动CDN（中国移动用户优化）
#   - telecom:  电信CDN（中国电信用户优化）
#   - china:    国内CDN（国内通用节点）
#   - overseas: 国外CDN（海外用户优化）
#   - backup:   备用CDN（备份/灰度测试）
#   - default:  默认CDN（兜底节点）

# 🏠 私有网络CDN（内网/开发环境）
# 用途: 内网访问、开发测试
# 示例: 公司内网服务器、本地开发环境
CDN_PRIVATE_DOMAIN=localhost
CDN_PRIVATE_PROTOCOL=http
CDN_PRIVATE_PORT=

# 📱 联通CDN（中国联通用户优化）
# 用途: 联通宽带/4G/5G用户专用节点
# 示例: 联通自有CDN、联通优化线路
CDN_UNICOM_DOMAIN=cdn-unicom.example.com
CDN_UNICOM_PROTOCOL=https
CDN_UNICOM_PORT=

# 📱 移动CDN（中国移动用户优化）
# 用途: 移动宽带/4G/5G用户专用节点
# 示例: 移动自有CDN、移动优化线路
CDN_MOBILE_DOMAIN=cdn-mobile.example.com
CDN_MOBILE_PROTOCOL=https
CDN_MOBILE_PORT=

# 📞 电信CDN（中国电信用户优化）
# 用途: 电信宽带/4G/5G用户专用节点
# 示例: 电信自有CDN、电信优化线路
CDN_TELECOM_DOMAIN=cdn-telecom.example.com
CDN_TELECOM_PROTOCOL=https
CDN_TELECOM_PORT=

# 🇨🇳 国内CDN（国内通用节点）
# 用途: 国内用户通用加速节点
# 示例: 阿里云CDN、腾讯云CDN、七牛云CDN
CDN_CHINA_DOMAIN=cdn-china.example.com
CDN_CHINA_PROTOCOL=https
CDN_CHINA_PORT=

# 🌏 国外CDN（海外用户优化）
# 用途: 海外用户访问加速
# 示例: Cloudflare、AWS CloudFront、Azure CDN
CDN_OVERSEAS_DOMAIN=cdn-overseas.example.com
CDN_OVERSEAS_PROTOCOL=https
CDN_OVERSEAS_PORT=

# 🔄 备用CDN（备份/灰度测试）
# 用途: 主CDN故障时的备份、新CDN灰度测试
# 示例: 备用源站、测试环境CDN
CDN_BACKUP_DOMAIN=cdn-backup.example.com
CDN_BACKUP_PROTOCOL=https
CDN_BACKUP_PORT=

# 🛡️ 默认CDN（兜底节点）
# 用途: 所有规则都不匹配时使用
# 示例: 主CDN、通用CDN
CDN_DEFAULT_DOMAIN=cdn.example.com
CDN_DEFAULT_PROTOCOL=https
CDN_DEFAULT_PORT=

# ========================================
# 💾 数据存储配置
# ========================================

# 🔴 Redis配置（必需，用于缓存和访问统计）
# Redis 服务器地址
REDIS_HOST=127.0.0.1

# Redis 端口
REDIS_PORT=6379

# Redis 密码（如果没有密码则留空）
REDIS_PASSWORD=

# Redis 数据库编号（0-15）
# 建议不同服务使用不同的DB编号避免冲突
REDIS_DATABASE=0

# 🗄️ MySQL配置（必需，用于存储短链数据）
# MySQL 服务器地址
MYSQL_HOST=127.0.0.1

# MySQL 端口
MYSQL_PORT=3306

# MySQL 数据库名称
# 注意: 需要提前创建此数据库
MYSQL_DATABASE=short_links

# MySQL 用户名
MYSQL_USER=root

# MySQL 密码
# ⚠️ 生产环境请使用强密码！
MYSQL_PASSWORD=your_strong_password
# ========================================
# 🌍 GeoIP地理位置数据库配置
# ========================================
# 说明:
#   - GeoIP数据库用于智能CDN分流（根据用户地理位置和运营商）
#   - 支持MaxMind GeoLite2免费数据库
#   - 下载地址: https://dev.maxmind.com/geoip/geoip2/geolite2/
#
# 国家数据库（必需，用于国家/地区识别）
GEOIP_COUNTRY_DB=/usr/local/openresty/nginx/geoip/Country-without-asn.mmdb

# 城市数据库（可选，用于省份/城市识别）
GEOIP_CITY_DB=/usr/local/openresty/nginx/geoip/GeoLite2-City.mmdb

# ASN数据库（可选，用于运营商识别）
GEOIP_ASN_DB=/usr/local/openresty/nginx/geoip/GeoLite2-ASN.mmdb

# ========================================
# 📊 日志和调试配置
# ========================================
# 日志级别: debug, info, warn, error
# 说明:
#   - debug: 详细调试信息（开发环境）
#   - info: 常规信息（生产环境推荐）
#   - warn: 警告信息
#   - error: 仅错误信息
LOG_LEVEL=info

# ========================================
# ⚡ 缓存优化配置
# ========================================
# 本地缓存时间（秒）
# 说明: Lua内存缓存，减少频繁读取配置文件
# 建议: 300秒（5分钟）
CACHE_LOCAL_TTL=300

# Redis缓存时间（秒）
# 说明: 短链目标URL的Redis缓存时间
# 建议: 3600秒（1小时）
CACHE_REDIS_TTL=3600

# ========================================
# 🔐 安全配置
# ========================================
# ⚠️ 重要: 生产环境必须修改默认密钥！

# 🔑 API密钥配置
# 说明:
#   - 用于外部服务调用短链API时的身份验证
#   - 支持多个API KEY，用逗号分隔（例如: key1,key2,key3）
#   - 留空则不需要API KEY验证（不推荐生产环境）
#   - 生成建议: openssl rand -hex 32
#
# 是否启用API KEY验证（true/false）
API_KEY_ENABLED=false

# API密钥列表（多个用逗号分隔，不要有空格）
# 示例: abc123def456,xyz789uvw,imagebed-api-key
API_KEY=

# 🔐 JWT Token配置
# JWT密钥（用于生成和验证Token）
# ⚠️ 生产环境务必修改为强随机字符串！
# 生成建议: openssl rand -hex 32
DEFAULT_TOKEN_SECRET=change-me-in-production-use-strong-random-string

# Token有效期（秒）
# 示例: 3600（1小时）, 86400（24小时）
TOKEN_EXPIRE=3600

# 🚦 IP访问限流配置（防止滥用）
# 单个IP在时间窗口内的最大请求数
RATE_LIMIT_MAX=100

# 限流时间窗口（秒）
# 示例: 60秒内最多100次请求
RATE_LIMIT_WINDOW=60

# 🛡️ API限流配置（针对API KEY）
# 每个API KEY在时间窗口内的最大请求数
API_RATE_LIMIT_MAX=1000

# API限流时间窗口（秒）
API_RATE_LIMIT_WINDOW=60

# ========================================
# 🏥 健康检查配置
# ========================================
# 健康检查间隔（秒）
HEALTH_CHECK_INTERVAL=5

# 健康检查超时时间（毫秒）
HEALTH_CHECK_TIMEOUT=2000

# 连续失败多少次触发下线
HEALTH_CHECK_FALL=3

# 连续成功多少次触发上线
HEALTH_CHECK_RISE=2

# 健康检查路径
HEALTH_CHECK_PATH=/health

# ========================================
# 👨‍💼 管理后台配置
# ========================================
# 是否启用管理后台认证（true/false）
ADMIN_AUTH_ENABLED=true

# 管理员用户名
# ⚠️ 生产环境请修改！
ADMIN_USERNAME=admin

# 管理员密码
# ⚠️ 生产环境请修改为强密码！
ADMIN_PASSWORD=admin123

# ========================================
# 💡 配置示例和常见场景
# ========================================
#
# 🏠 场景1: 本地开发环境（最简单）
# -----------------------------------
# REDIRECT_DOMAIN=localhost
# REDIRECT_PROTOCOL=http
# CDN_PRIVATE_DOMAIN=localhost
# CDN_PRIVATE_PROTOCOL=http
# CDN_DEFAULT_DOMAIN=localhost
# CDN_DEFAULT_PROTOCOL=http
# API_KEY_ENABLED=false
# LOG_LEVEL=debug
#
# 💡 说明:
#   - 使用本地环境，不需要真实CDN
#   - 不启用API KEY验证，方便测试
#   - 调试日志级别，便于排查问题
#
# 🌐 场景2: 单CDN生产环境
# -----------------------------------
# REDIRECT_DOMAIN=s.yourdomain.com
# REDIRECT_PROTOCOL=https
# CDN_DEFAULT_DOMAIN=cdn.yourdomain.com
# CDN_DEFAULT_PROTOCOL=https
# API_KEY_ENABLED=true
# API_KEY=your-secure-api-key-generated-by-openssl
# DEFAULT_TOKEN_SECRET=your-jwt-secret-generated-by-openssl
# ADMIN_PASSWORD=your-strong-admin-password
# LOG_LEVEL=info
#
# 💡 说明:
#   - 使用HTTPS协议保证安全
#   - 启用API KEY验证
#   - 修改所有默认密码
#   - 只使用一个CDN节点（默认节点）
#
# 🚀 场景3: 多CDN智能分流（推荐生产环境）
# -----------------------------------
# REDIRECT_DOMAIN=s.yourdomain.com
# REDIRECT_PROTOCOL=https
#
# # 配置多个CDN节点
# CDN_TELECOM_DOMAIN=cdn-ct.yourdomain.com
# CDN_TELECOM_PROTOCOL=https
# CDN_UNICOM_DOMAIN=cdn-cu.yourdomain.com
# CDN_UNICOM_PROTOCOL=https
# CDN_MOBILE_DOMAIN=cdn-cm.yourdomain.com
# CDN_MOBILE_PROTOCOL=https
# CDN_CHINA_DOMAIN=cdn.yourdomain.com
# CDN_CHINA_PROTOCOL=https
# CDN_OVERSEAS_DOMAIN=cdn-global.yourdomain.com
# CDN_OVERSEAS_PROTOCOL=https
# CDN_BACKUP_DOMAIN=cdn-backup.yourdomain.com
# CDN_BACKUP_PROTOCOL=https
# CDN_DEFAULT_DOMAIN=cdn-default.yourdomain.com
# CDN_DEFAULT_PROTOCOL=https
#
# # 安全配置
# API_KEY_ENABLED=true
# API_KEY=imagebed-key-abc123,blog-key-def456,app-key-xyz789
# DEFAULT_TOKEN_SECRET=$(openssl rand -hex 32)
# ADMIN_PASSWORD=your-strong-admin-password
#
# # 限流配置
# RATE_LIMIT_MAX=200
# API_RATE_LIMIT_MAX=2000
#
# # 日志和缓存
# LOG_LEVEL=info
# CACHE_LOCAL_TTL=300
# CACHE_REDIS_TTL=3600
#
# 💡 说明:
#   - 根据运营商智能分流（电信/联通/移动）
#   - 国内外分流（国内/海外CDN）
#   - 支持多个应用接入（不同API KEY）
#   - 配置备用CDN防止故障
#   - 在 routing_rules.yaml 中配置详细分流规则
#
# 📱 场景4: 图床+短链集成部署
# -----------------------------------
# # 短链服务配置
# REDIRECT_DOMAIN=s.yourdomain.com
# REDIRECT_PROTOCOL=https
# API_KEY_ENABLED=true
# API_KEY=imagebed-service-key-123456
#
# # CDN配置（指向图床服务）
# CDN_DEFAULT_DOMAIN=imagebed.yourdomain.com
# CDN_DEFAULT_PROTOCOL=https
# CDN_CHINA_DOMAIN=cdn-china.yourdomain.com
# CDN_CHINA_PROTOCOL=https
# CDN_OVERSEAS_DOMAIN=cdn-global.yourdomain.com
# CDN_OVERSEAS_PROTOCOL=https
#
# # 图床服务配置（backend/.env）
# SHORT_LINK_ENABLED=true
# SHORT_LINK_BASE_URL=https://s.yourdomain.com
# SHORT_LINK_API_KEY=imagebed-service-key-123456
#
# 💡 说明:
#   - 图床上传后自动生成短链
#   - 短链重定向到对应的CDN
#   - API KEY要在两个服务中保持一致
#
# ========================================
# ⚠️ 注意事项
# ========================================
# 1. 必须修改的配置（生产环境）:
#    ✅ DEFAULT_TOKEN_SECRET: 使用 openssl rand -hex 32 生成
#    ✅ MYSQL_PASSWORD: 使用强密码
#    ✅ ADMIN_PASSWORD: 修改默认管理员密码
#    ✅ API_KEY: 如果启用API验证，配置强随机密钥
#
# 2. 数据库准备:
#    ✅ MySQL需要提前创建数据库: CREATE DATABASE short_links;
#    ✅ 建议创建专用用户，不要使用root
#    ✅ 首次运行会自动创建表结构
#
# 3. Redis缓存:
#    ✅ 必须安装和启动Redis服务
#    ✅ 建议配置Redis持久化（AOF或RDB）
#    ✅ 不同服务使用不同的DB编号
#
# 4. CDN节点配置:
#    ✅ 可以自由增减CDN节点，详见 CDN_NODES_GUIDE.md
#    ✅ 只需要的节点可以不配置
#    ✅ 必须至少配置一个default节点作为兜底
#
# 5. 路由规则配置:
#    ✅ 在 routing_rules.yaml 中配置分流规则
#    ✅ 支持10种条件类型，可组合使用
#    ✅ 修改后自动生效（缓存5分钟）
#    ✅ 详见 ROUTING_CONFIG_GUIDE.md
#
# 6. GeoIP数据库:
#    ✅ 智能分流需要下载GeoIP数据库
#    ✅ 免费版: https://dev.maxmind.com/geoip/geoip2/geolite2/
#    ✅ 需要定期更新（每月）
#
# 7. API KEY配置:
#    ✅ 支持多个API KEY，用逗号分隔
#    ✅ 每个接入的应用使用不同的KEY
#    ✅ 图床服务的 SHORT_LINK_API_KEY 要与此处一致
#
# 8. 限流配置:
#    ✅ RATE_LIMIT_*: 针对IP的限流（防止恶意访问）
#    ✅ API_RATE_LIMIT_*: 针对API KEY的限流（防止滥用）
#    ✅ 根据实际流量调整参数
#
# 9. 日志配置:
#    ✅ 生产环境建议使用 info 或 warn 级别
#    ✅ 日志会输出到 Nginx error.log
#    ✅ 可通过 docker-compose logs 查看
#
# 10. HTTPS配置:
#    ✅ 生产环境强烈建议使用HTTPS
#    ✅ 需要在Nginx配置SSL证书
#    ✅ 可使用Let's Encrypt免费证书
#
# ========================================
# 🔧 配置生成工具
# ========================================
# 生成JWT密钥:
#   openssl rand -hex 32
#
# 生成API KEY:
#   openssl rand -hex 32
#
# 生成强密码:
#   openssl rand -base64 24
#
# 测试配置:
#   bash:       ./scripts/validate_config.sh
#   powershell: .\scripts\validate_config.ps1
#
# ========================================
# 📚 相关文档
# ========================================
# - 快速入门: ROUTING_QUICK_START.md
# - 完整配置指南: ROUTING_CONFIG_GUIDE.md
# - CDN节点配置: CDN_NODES_GUIDE.md
# - 路由规则说明: ROUTING_README.md
# - 图床集成: ../SHORTLINK_QUICK_REF.md
# ========================================

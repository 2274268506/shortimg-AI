# GeoIP è‡ªåŠ¨é€‰æ‹©åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æˆåŠŸå®ç°äº†çŸ­é“¾æœåŠ¡æ ¹æ®åˆ†æµè§„åˆ™è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ GeoIP æ•°æ®åº“åŠŸèƒ½ã€‚ç³»ç»Ÿä¼šæ™ºèƒ½åˆ†æè·¯ç”±é…ç½®éœ€æ±‚ï¼Œåœ¨ `qqwry.dat` å’Œ `GeoLite2-*.mmdb` ä¹‹é—´è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç»„åˆã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. GeoIP æ•°æ®åº“æ”¯æŒ

å·²æ”¯æŒä»¥ä¸‹ 4 ä¸ª GeoIP æ•°æ®åº“ï¼š

| æ•°æ®åº“ | å¤§å° | ç”¨é€” | ä¼˜å…ˆçº§ |
|--------|------|------|--------|
| **qqwry.dat** | 25.38 MB | å›½å†…IPï¼Œè¿è¥å•†è¯†åˆ« | æœ€é«˜ (10) |
| **GeoLite2-Country.mmdb** | 9.25 MB | å…¨çƒå›½å®¶çº§åˆ†æµ | é«˜ (20) |
| **GeoLite2-ASN.mmdb** | 10.4 MB | ASN/è¿è¥å•†è¯†åˆ« | é«˜ (15) |
| **GeoLite2-City.mmdb** | 60.27 MB | å…¨çƒåŸå¸‚çº§ç²¾åº¦ | ä¸­ (30) |

### 2. æ ¸å¿ƒæ¨¡å—

#### geoip_manager.lua (371 è¡Œ)
- âœ… åˆ†æè·¯ç”±è§„åˆ™éœ€æ±‚ï¼ˆå›½å®¶/çœä»½/åŸå¸‚/ISP/ASNï¼‰
- âœ… è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ•°æ®åº“ç»„åˆ
- âœ… è¯„åˆ†ç³»ç»Ÿä¼˜åŒ–é€‰æ‹©ï¼ˆåŸºäºä¼˜å…ˆçº§å’ŒåŠŸèƒ½åŒ¹é…ï¼‰
- âœ… æ•°æ®åº“éªŒè¯å’Œæ¨èç”Ÿæˆ
- âœ… é’ˆå¯¹ä¸­å›½IPçš„ç‰¹æ®Šä¼˜åŒ–

#### geoip_query.lua (311 è¡Œ)
- âœ… ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
- âœ… æ”¯æŒ qqwry.dat æ ¼å¼ï¼ˆçº¯çœŸIPåº“ï¼‰
- âœ… æ”¯æŒ MaxMind MMDB æ ¼å¼
- âœ… å¤šæ•°æ®åº“å¹¶è¡ŒæŸ¥è¯¢
- âœ… ç»“æœæ™ºèƒ½åˆå¹¶
- âœ… æ•°æ®åº“ç¼“å­˜æœºåˆ¶

#### geoip_admin_api.lua (168 è¡Œ)
- âœ… REST API æ¥å£
- âœ… 6 ä¸ªç®¡ç†ç«¯ç‚¹
- âœ… JSON å“åº”æ ¼å¼
- âœ… é”™è¯¯å¤„ç†

#### test_geoip.lua (116 è¡Œ)
- âœ… å®Œæ•´çš„æµ‹è¯•è„šæœ¬
- âœ… æ•°æ®åº“éªŒè¯
- âœ… æ¨¡æ‹Ÿè·¯ç”±è§„åˆ™æµ‹è¯•
- âœ… IP æŸ¥è¯¢æµ‹è¯•

### 3. è·¯ç”±å¼•æ“é›†æˆ

å·²é›†æˆåˆ° `routing_engine.lua`:
- âœ… è‡ªåŠ¨åŠ è½½ GeoIP æ¨¡å—
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨é€‰æ‹©æ•°æ®åº“
- âœ… æä¾› GeoIP æŸ¥è¯¢æ¥å£
- âœ… é…ç½®é‡è½½æ”¯æŒ
- âœ… æ—¥å¿—è®°å½•

### 4. ç®¡ç† API

æä¾› 6 ä¸ªç®¡ç†æ¥å£ï¼š

```bash
GET  /admin/geoip/databases       # æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“
GET  /admin/geoip/selected        # æŸ¥çœ‹é€‰ä¸­çš„æ•°æ®åº“
GET  /admin/geoip/validate        # éªŒè¯æ•°æ®åº“æ–‡ä»¶
GET  /admin/geoip/recommendations # è·å–æ¨èé…ç½®
POST /admin/geoip/query           # æµ‹è¯•IPæŸ¥è¯¢
POST /admin/geoip/reload          # é‡è½½é…ç½®
```

## ğŸ¯ è‡ªåŠ¨é€‰æ‹©ç­–ç•¥

### é€‰æ‹©é€»è¾‘

ç³»ç»Ÿæ ¹æ®è·¯ç”±è§„åˆ™ä¸­çš„æ¡ä»¶ç±»å‹è‡ªåŠ¨é€‰æ‹©æ•°æ®åº“ï¼š

| è·¯ç”±éœ€æ±‚ | è‡ªåŠ¨é€‰æ‹© | åŸå›  |
|----------|---------|------|
| å›½å†…è¿è¥å•† (isp) | qqwry.dat | åŒ…å«è¯¦ç»†çš„è¿è¥å•†ä¿¡æ¯ |
| çœä»½ (province) | qqwry.dat | åŒ…å«è¯¦ç»†çš„çœä»½ä¿¡æ¯ |
| å›½å®¶ (country) | GeoLite2-Country.mmdb | ä½“ç§¯å°ï¼Œå…¨çƒè¦†ç›– |
| ASN (asn) | GeoLite2-ASN.mmdb | ä¸“é—¨çš„ASNæ•°æ®åº“ |
| åŸå¸‚ (city) | GeoLite2-City.mmdb | åŸå¸‚çº§ç²¾åº¦ |

### è¯„åˆ†ç³»ç»Ÿ

æ¯ä¸ªæ•°æ®åº“æ ¹æ®ä»¥ä¸‹å› ç´ è®¡ç®—å¾—åˆ†ï¼š
- **åŸºç¡€åˆ†**: 100 - ä¼˜å…ˆçº§ (ä¼˜å…ˆçº§è¶Šé«˜åˆ†æ•°è¶Šé«˜)
- **åŠŸèƒ½åŒ¹é…**: æ»¡è¶³è·¯ç”±éœ€æ±‚ +15~25åˆ†
- **ä¸“ç”¨åŠ åˆ†**: é’ˆå¯¹ç‰¹å®šéœ€æ±‚ï¼ˆå¦‚ qqwry.dat é’ˆå¯¹ä¸­å›½IPï¼‰+30åˆ†
- **å…¨çƒè¦†ç›–**: æ”¯æŒå…¨çƒæŸ¥è¯¢ +10åˆ†

### ç¤ºä¾‹åœºæ™¯

#### åœºæ™¯ 1: å›½å†…ä¸‰ç½‘åˆ†æµ
```lua
conditions = {
    {type = "country", value = "CN"},
    {type = "isp", values = {"China Telecom"}}
}
```
**é€‰æ‹©**: `qqwry.dat` (å¾—åˆ† ~145)

#### åœºæ™¯ 2: å›½å†…å¤–åˆ†æµ
```lua
conditions = {
    {type = "country", value = "CN"}
}
```
**é€‰æ‹©**: `GeoLite2-Country.mmdb` (å¾—åˆ† ~110)

#### åœºæ™¯ 3: çœä»½çº§åˆ†æµ
```lua
conditions = {
    {type = "province", values = {"åŒ—äº¬", "ä¸Šæµ·"}}
}
```
**é€‰æ‹©**: `qqwry.dat` (å¾—åˆ† ~145)

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å†…å­˜å ç”¨
- qqwry.dat: ~8MB
- GeoLite2-Country: ~6MB
- GeoLite2-City: ~70MB
- GeoLite2-ASN: ~5MB

### æŸ¥è¯¢é€Ÿåº¦
- qqwry.dat: ~0.1ms
- GeoLite2-Country: ~0.05ms
- GeoLite2-City: ~0.2ms
- GeoLite2-ASN: ~0.05ms

### æ¨èç»„åˆ
- **çº¯å›½å†…ä¸šåŠ¡**: qqwry.dat
- **å›½å†…å¤–ä¸šåŠ¡**: qqwry.dat + GeoLite2-Country.mmdb
- **å…¨çƒä¸šåŠ¡**: GeoLite2-City.mmdb + GeoLite2-ASN.mmdb

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
redirect-service/
â”œâ”€â”€ lua/
â”‚   â”œâ”€â”€ geoip_manager.lua       (371 è¡Œ) - æ•°æ®åº“ç®¡ç†å™¨
â”‚   â”œâ”€â”€ geoip_query.lua         (311 è¡Œ) - æŸ¥è¯¢æ¨¡å—
â”‚   â”œâ”€â”€ geoip_admin_api.lua     (168 è¡Œ) - ç®¡ç†API
â”‚   â””â”€â”€ test_geoip.lua          (116 è¡Œ) - æµ‹è¯•è„šæœ¬
â”œâ”€â”€ geoip/
â”‚   â”œâ”€â”€ qqwry.dat               (25.38 MB) - çº¯çœŸIPåº“
â”‚   â”œâ”€â”€ GeoLite2-Country.mmdb   (9.25 MB) - å›½å®¶åº“
â”‚   â”œâ”€â”€ GeoLite2-City.mmdb      (60.27 MB) - åŸå¸‚åº“
â”‚   â””â”€â”€ GeoLite2-ASN.mmdb       (10.4 MB) - ASNåº“
â”œâ”€â”€ GEOIP_AUTO_SELECT.md        - è¯¦ç»†æ–‡æ¡£
â””â”€â”€ (ä¿®æ”¹) routing_engine.lua   - é›†æˆGeoIPåŠŸèƒ½

test-geoip-feature.ps1          - æµ‹è¯•è„šæœ¬
```

### ä¿®æ”¹æ–‡ä»¶
```
redirect-service/lua/routing_engine.lua
â”œâ”€â”€ æ–°å¢: require "geoip_manager"
â”œâ”€â”€ æ–°å¢: require "geoip_query"
â”œâ”€â”€ æ–°å¢: selected_geoip_databases ç¼“å­˜
â”œâ”€â”€ æ–°å¢: get_selected_geoip_databases()
â”œâ”€â”€ æ–°å¢: query_geoip()
â”œâ”€â”€ æ–°å¢: get_geoip_recommendations()
â”œâ”€â”€ æ–°å¢: get_available_geoip_databases()
â””â”€â”€ æ–°å¢: validate_geoip_databases()
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰

ç³»ç»Ÿä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ†æè·¯ç”±è§„åˆ™å¹¶é€‰æ‹©æ•°æ®åº“ï¼š

```lua
-- routing_config_simple.lua
routing_rules = {
    {
        name = "å›¾åºŠ_ç”µä¿¡",
        conditions = {
            {type = "service_type", value = "imagebed"},
            {type = "isp", values = {"China Telecom"}}
        },
        target = "imagebed_telecom"
    }
}
```

å¯åŠ¨æ—¶æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
[RoutingEngine] é…ç½®å·²åŠ è½½
[RoutingEngine] å·²é€‰æ‹© 2 ä¸ª GeoIP æ•°æ®åº“
[RoutingEngine]   - çº¯çœŸIPæ•°æ®åº“ (å¾—åˆ†: 145)
[RoutingEngine]   - GeoLite2 Country (å¾—åˆ†: 110)
```

### 2. API æŸ¥è¯¢

```bash
# æŸ¥çœ‹é€‰ä¸­çš„æ•°æ®åº“
curl http://localhost:8080/admin/geoip/selected

# æµ‹è¯•IPæŸ¥è¯¢
curl -X POST http://localhost:8080/admin/geoip/query \
     -H "Content-Type: application/json" \
     -d '{"ip":"1.2.3.4"}'
```

### 3. Lua è°ƒç”¨

```lua
local routing_engine = require "routing_engine"

-- æŸ¥è¯¢IP
local result = routing_engine.query_geoip("1.2.3.4")
print(result.country)    -- "China"
print(result.isp)        -- "China Telecom"
print(result.province)   -- "ç¦å»ºçœ"
```

## ğŸ‰ æ ¸å¿ƒä¼˜åŠ¿

1. **æ™ºèƒ½åŒ–**: è‡ªåŠ¨åˆ†æè·¯ç”±éœ€æ±‚ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
2. **ä¼˜åŒ–çš„**: è¯„åˆ†ç³»ç»Ÿç¡®ä¿é€‰æ‹©æœ€ä¼˜æ•°æ®åº“ç»„åˆ
3. **é«˜æ€§èƒ½**: æ•°æ®åº“ç¼“å­˜å’Œå¹¶è¡ŒæŸ¥è¯¢
4. **çµæ´»æ€§**: æ”¯æŒå¤šç§æ•°æ®åº“æ ¼å¼
5. **æ˜“ç»´æŠ¤**: å®Œå–„çš„ API å’Œæ—¥å¿—ç³»ç»Ÿ
6. **å‡†ç¡®æ€§**: é’ˆå¯¹ä¸­å›½IPä½¿ç”¨ä¸“ç”¨æ•°æ®åº“

## ğŸ“– æ–‡æ¡£

- **è¯¦ç»†æ–‡æ¡£**: `redirect-service/GEOIP_AUTO_SELECT.md`
- **æµ‹è¯•è„šæœ¬**: `test-geoip-feature.ps1`
- **ä»£ç ç¤ºä¾‹**: `redirect-service/lua/test_geoip.lua`

## ğŸš€ ä¸‹ä¸€æ­¥

å»ºè®®çš„åç»­ä¼˜åŒ–ï¼š
1. æ·»åŠ æ•°æ®åº“è‡ªåŠ¨æ›´æ–°è„šæœ¬
2. å®ç°æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆåŸºäºIPï¼‰
3. æ·»åŠ  Prometheus ç›‘æ§æŒ‡æ ‡
4. æ”¯æŒè‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
5. å®ç°æ•°æ®åº“çƒ­é‡è½½ï¼ˆæ— éœ€é‡å¯ï¼‰

## âœ¨ æ€»ç»“

æˆåŠŸå®ç°äº†ä¸€ä¸ªæ™ºèƒ½çš„ GeoIP æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®å®é™…çš„è·¯ç”±åˆ†æµè§„åˆ™è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ•°æ®åº“ã€‚ç³»ç»Ÿå¯¹ `qqwry.dat` å’Œ `GeoLite2-*.mmdb` æä¾›äº†å®Œæ•´æ”¯æŒï¼Œå¹¶é€šè¿‡è¯„åˆ†æœºåˆ¶ç¡®ä¿æœ€ä¼˜é€‰æ‹©ã€‚

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•éªŒè¯ï¼âœ…

# ShortImg-AI Backend 生产环境配置清单

## ✅ 部署前检查清单

### 服务器准备
- [ ] 服务器操作系统：Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- [ ] CPU：2核或以上
- [ ] 内存：4GB或以上（推荐8GB）
- [ ] 磁盘：20GB或以上可用空间
- [ ] 已安装 Docker (20.10+)
- [ ] 已安装 Docker Compose (1.29+)

### 域名和 SSL
- [ ] 已购买域名
- [ ] 域名已解析到服务器 IP
- [ ] 已获取 SSL 证书（或准备使用 Let's Encrypt）

### 安全配置
- [ ] 已修改 MySQL root 密码
- [ ] 已修改 MySQL 用户密码
- [ ] 已生成 JWT 密钥（至少32字符）
- [ ] 已配置正确的 CORS 域名
- [ ] 已关闭用户注册（ALLOW_REGISTRATION=false）

### 存储配置
- [ ] 已选择存储类型（local/s3/oss/cos）
- [ ] 如使用云存储，已配置密钥
- [ ] 已规划磁盘空间（根据预期使用量）

### 网络配置
- [ ] 防火墙已配置
  - [ ] 允许 80 端口（HTTP）
  - [ ] 允许 443 端口（HTTPS）
  - [ ] 禁止直接访问 3306（MySQL）
  - [ ] 禁止直接访问 6379（Redis）
  - [ ] 禁止直接访问 8080（Backend，通过 Nginx 代理）
- [ ] 已安装并配置 Nginx 反向代理

### 监控和日志
- [ ] 已配置日志轮转
- [ ] 已设置自动备份任务
- [ ] 已配置监控告警（可选）

## 📋 部署步骤清单

### 1. 准备阶段
- [ ] 克隆代码到服务器
- [ ] 创建数据目录：`/root/docker/shortimg-ai/`
- [ ] 复制 `.env.prod` 为 `.env`
- [ ] 编辑 `.env` 文件，修改所有敏感信息

### 2. 配置阶段
- [ ] 创建 MySQL 配置文件
- [ ] 创建 Redis 配置文件（可选）
- [ ] 配置 Nginx 反向代理
- [ ] 申请 SSL 证书

### 3. 部署阶段
- [ ] 运行 `deploy-prod.sh` 脚本
- [ ] 或手动执行 `docker-compose -f docker-compose.prod.yml up -d`
- [ ] 查看服务状态
- [ ] 查看服务日志

### 4. 验证阶段
- [ ] 访问健康检查端点：`http://your-domain.com/health`
- [ ] 访问 API 文档：`http://your-domain.com/swagger/index.html`
- [ ] 测试文件上传功能
- [ ] 测试用户登录功能
- [ ] 测试短链生成功能（如启用）

### 5. 备份配置
- [ ] 赋予备份脚本执行权限
- [ ] 手动测试数据库备份
- [ ] 手动测试文件备份
- [ ] 配置 cron 定时备份

### 6. 运维配置
- [ ] 配置日志监控
- [ ] 配置资源监控（可选）
- [ ] 配置告警通知（可选）
- [ ] 编写运维文档

## 🔐 安全加固清单

### 系统安全
- [ ] 禁用 root 远程登录
- [ ] 使用密钥登录，禁用密码登录
- [ ] 配置 fail2ban 防止暴力破解
- [ ] 定期更新系统和软件包
- [ ] 配置防火墙（UFW 或 iptables）

### 应用安全
- [ ] 使用强密码（所有密码至少16字符）
- [ ] JWT 密钥足够复杂（至少32字符）
- [ ] 禁用不必要的 API 端点
- [ ] 配置 API 访问频率限制
- [ ] 启用 HTTPS
- [ ] 配置 HSTS
- [ ] 配置 CSP（内容安全策略）

### 数据安全
- [ ] 定期备份数据库（每天）
- [ ] 定期备份文件（每天）
- [ ] 备份文件异地存储
- [ ] 测试备份恢复流程
- [ ] 加密敏感数据

### Docker 安全
- [ ] 使用最新稳定版镜像
- [ ] 定期更新镜像
- [ ] 限制容器资源使用
- [ ] 使用非 root 用户运行容器
- [ ] 扫描镜像漏洞

## 📊 性能优化清单

### MySQL 优化
- [ ] 调整 innodb_buffer_pool_size（推荐物理内存的50-70%）
- [ ] 配置慢查询日志
- [ ] 定期分析和优化表
- [ ] 配置合适的连接池大小
- [ ] 启用查询缓存（MySQL 5.7）

### Redis 优化
- [ ] 配置最大内存限制
- [ ] 选择合适的淘汰策略
- [ ] 启用持久化
- [ ] 优化过期键删除策略

### Nginx 优化
- [ ] 启用 gzip 压缩
- [ ] 配置静态文件缓存
- [ ] 启用 HTTP/2
- [ ] 配置连接池
- [ ] 优化 worker 进程数

### 应用优化
- [ ] 启用 Redis 缓存
- [ ] 优化数据库查询
- [ ] 配置合适的日志级别
- [ ] 启用 CDN（如使用云存储）
- [ ] 图片压缩和格式转换

## 🔍 监控指标清单

### 服务监控
- [ ] 服务可用性（uptime）
- [ ] HTTP 响应时间
- [ ] HTTP 错误率
- [ ] 请求并发数

### 数据库监控
- [ ] MySQL 连接数
- [ ] MySQL 慢查询数
- [ ] MySQL 锁等待
- [ ] 数据库大小

### 缓存监控
- [ ] Redis 内存使用率
- [ ] Redis 缓存命中率
- [ ] Redis 键空间
- [ ] Redis 连接数

### 系统监控
- [ ] CPU 使用率
- [ ] 内存使用率
- [ ] 磁盘使用率
- [ ] 磁盘 I/O
- [ ] 网络流量

### 业务监控
- [ ] 用户注册数
- [ ] 图片上传数
- [ ] 短链生成数
- [ ] 存储空间使用

## 📝 文档清单

- [ ] 部署文档（PRODUCTION_DEPLOY.md）
- [ ] 快速开始（README.prod.md）
- [ ] API 文档（Swagger）
- [ ] 运维手册
- [ ] 故障排查手册
- [ ] 备份恢复流程
- [ ] 应急响应预案

## 🆘 应急响应清单

### 服务宕机
- [ ] 检查容器状态
- [ ] 查看日志
- [ ] 重启服务
- [ ] 联系技术支持

### 数据库故障
- [ ] 检查 MySQL 状态
- [ ] 查看错误日志
- [ ] 检查磁盘空间
- [ ] 从备份恢复

### 磁盘空间不足
- [ ] 清理日志文件
- [ ] 清理临时文件
- [ ] 清理 Docker 资源
- [ ] 扩容磁盘

### 性能问题
- [ ] 检查资源使用
- [ ] 分析慢查询
- [ ] 优化数据库
- [ ] 扩容服务器

---

## ✅ 最终确认

部署完成后，请确认：

- [ ] 所有服务正常运行
- [ ] 所有检查项通过
- [ ] 健康检查端点正常响应
- [ ] API 文档可以访问
- [ ] 前端可以正常连接后端
- [ ] 文件上传功能正常
- [ ] 用户登录功能正常
- [ ] 备份任务配置完成
- [ ] 监控告警配置完成

**签署确认：**

- 部署日期：__________
- 部署人员：__________
- 验收人员：__________

---

**注意事项：**

1. 本清单仅供参考，请根据实际情况调整
2. 部署前请仔细阅读所有文档
3. 建议先在测试环境验证后再部署到生产环境
4. 重要操作前请先备份数据
5. 如遇问题，请及时查看日志并寻求支持

🎉 祝部署顺利！
